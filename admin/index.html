<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | ShepherdNet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #4facfe; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f172a; color: white; font-family: 'Poppins', sans-serif; display: flex; min-height: 100vh; }
    
    /* Sidebar */
    nav { width: 280px; background: var(--glass); backdrop-filter: blur(15px); border-right: 1px solid var(--border); padding: 40px 20px; display: flex; flex-direction: column; }
    
    /* Profile Section in Sidebar */
    .profile-link { 
        text-decoration: none; 
        padding: 15px; 
        background: rgba(79, 172, 254, 0.1); 
        border-radius: 15px; 
        margin-bottom: 40px; 
        border: 1px solid var(--border);
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .profile-link:hover { background: rgba(79, 172, 254, 0.2); transform: translateY(-2px); }
    .nav-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; background: #1e293b; }
    .profile-info h2 { font-size: 0.6rem; color: var(--primary); margin: 0; letter-spacing: 1px; text-transform: uppercase; }
    .profile-info p { font-size: 0.85rem; color: white; margin: 2px 0 0 0; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

    nav a { display: block; color: white; text-decoration: none; padding: 12px 15px; border-radius: 12px; opacity: 0.7; transition: 0.3s; margin-bottom: 5px; font-size: 0.9rem; }
    nav a:hover, nav a.active { opacity: 1; color: var(--primary); background: var(--glass); }

    /* Main Content */
    main { flex: 1; padding: 60px; overflow-y: auto; }
    #welcome-text { font-size: 2.5rem; font-weight: 300; margin-bottom: 5px; }
    #welcome-name { color: var(--primary); font-weight: 600; }
    .subtitle { opacity: 0.5; margin-bottom: 40px; }

    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .card { background: var(--glass); padding: 30px; border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
    .card h3 { font-size: 0.8rem; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; }
    .card p { font-size: 2.5rem; font-weight: bold; margin-top: 10px; color: white; }
    
    .action-card { background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 0, 0, 0)); border-color: rgba(79, 172, 254, 0.3); }
    .btn-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
    button { background: var(--primary); color: #0f172a; border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.3s; }
    button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
  </style>
</head>
<body>

  <nav>
    <a href="../list/settings.html" class="profile-link">
        <img id="nav-avatar" src="https://via.placeholder.com/40" class="nav-avatar">
        <div class="profile-info">
            <h2>Master Admin</h2>
            <p id="nav-name">Loading...</p>
        </div>
    </a>
    <a href="#" class="active">üåê General Overview</a>
    <a href="../list/index.html">üìã All Church Members</a>
    <a href="../dashboard/add-user.html">üîë Manage Users</a>
    <div style="flex-grow: 1;"></div>
    <a href="#" id="logoutBtn" style="color: #ff6b6b; opacity: 1;">üö™ Sign Out</a>
  </nav>

  <main>
    <h1 id="welcome-text">Welcome, <span id="welcome-name">Admin</span></h1>
    <p class="subtitle">System-wide analytics and management.</p>
    <div id="birthday-alerts" style="margin-bottom: 30px;">
    </div>

    <div class="stat-grid">
      <div class="card"><h3>Total Pastors</h3><p id="count-pastors">0</p></div>
      <div class="card"><h3>Total Shepherds</h3><p id="count-shepherds">0</p></div>
      <div class="card"><h3>Total Members</h3><p id="count-members">0</p></div>
    </div>
    
    <div class="card action-card">
      <h3>Quick Actions</h3>
      <div class="btn-group">
        <button onclick="location.href='../dashboard/add-user.html'">Add New Pastor</button>
        <button onclick="location.href='../dashboard/add-member.html'" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border);">Add New Member</button>
      </div>
    </div>
  </main>

<script type="module">
    // 1. ALL IMPORTS AT THE TOP
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { 
        initializeFirestore, doc, getDoc, collection, 
        getCountFromServer, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", 
        authDomain: "fob-database-139d1.firebaseapp.com", 
        projectId: "fob-database-139d1", 
        storageBucket: "fob-database-139d1.firebasestorage.app", 
        messagingSenderId: "375165731354", 
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" 
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // Use the specific database ID "fobrealdbase"
    const db = initializeFirestore(app, { experimentalForceLongPolling: true }, "fobrealdbase");

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "../index.html";
            return;
        }

        // --- STEP 1: LOAD PROFILE (PRIORITY) ---
        try {
           // NEW CODE (Correct collection)
              const adminSnap = await getDoc(doc(db, "pastors", user.uid));
            if (adminSnap.exists()) {
                const data = adminSnap.data();
                const fullName = data.full_name || "Admin";
                
                // Update UI immediately
                document.getElementById('welcome-name').innerText = fullName.split(' ')[0];
                document.getElementById('nav-name').innerText = fullName;
                
                if (data.profile_pic) {
                    document.getElementById('nav-avatar').src = data.profile_pic;
                }
            } else {
                document.getElementById('nav-name').innerText = "Unknown Admin";
            }
        } catch (err) {
            console.error("Profile Load Error:", err);
            document.getElementById('nav-name').innerText = "Error Loading";
        }

        // --- STEP 2: LOAD BACKGROUND DATA ---
        getStats();
        checkBirthdays();
    });

    async function getStats() {
        try {
            const [pCol, sCol, mCol] = await Promise.all([
                getCountFromServer(collection(db, "pastors")),
                getCountFromServer(collection(db, "shepherds")),
                getCountFromServer(collection(db, "members"))
            ]);
            
            document.getElementById('count-pastors').innerText = pCol.data().count;
            document.getElementById('count-shepherds').innerText = sCol.data().count;
            document.getElementById('count-members').innerText = mCol.data().count;
        } catch (e) { 
            console.error("Stats Error:", e); 
        }
    }

    async function checkBirthdays() {
        const alertContainer = document.getElementById('birthday-alerts');
        const today = new Date();
        const gmtMonth = String(today.getUTCMonth() + 1).padStart(2, '0');
        const gmtDay = String(today.getUTCDate()).padStart(2, '0');
        const todayGMT = `${gmtMonth}-${gmtDay}`;

        try {
            const q = query(collection(db, "members"), where("dob_day_month", "==", todayGMT));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                alertContainer.innerHTML = "<p style='opacity:0.5; font-size:0.8rem;'>No birthdays today.</p>";
                return;
            }

            let listHTML = "";
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const birthYear = new Date(data.dob).getFullYear();
                const age = today.getUTCFullYear() - birthYear;
                listHTML += `<li><strong>${data.first_name} ${data.last_name}</strong> (Turning ${age})</li>`;
            });

            alertContainer.innerHTML = `
                <div style="background: rgba(79, 172, 254, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 5px;">üéâ Birthday Alerts</h4>
                    <ul style="margin-top: 10px; list-style: none; font-size: 0.85rem;">${listHTML}</ul>
                </div>
            `;
        } catch (e) {
            console.error("Birthday Error:", e);
        }
    }

    // Logout Handler
    document.getElementById('logoutBtn').onclick = (e) => {
        e.preventDefault();
        signOut(auth).then(() => window.location.href="../index.html");
    };
</script>
</body>
</html>
