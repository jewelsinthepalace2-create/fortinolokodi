<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Member Profile | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --green: #00ff88; --red: #ff4b5c;
        }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 50px; }

        .profile-card {
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 24px; border: 1px solid var(--border);
            text-align: center; margin-bottom: 20px;
        }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; background: #1e293b; }
        h1 { font-size: 1.4rem; margin-bottom: 5px; }

        .filter-box { margin-bottom: 20px; }
        select { 
            width: 100%; padding: 12px; border-radius: 12px; background: #1e293b; 
            color: white; border: 1px solid var(--border); outline: none; font-family: inherit;
        }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--border); }
        .stat-val { display: block; font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-lab { font-size: 0.65rem; text-transform: uppercase; opacity: 0.6; }

        .chart-box { background: var(--glass); padding: 20px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        .history-list { background: var(--glass); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
        .history-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .history-item:last-child { border-bottom: none; }
        .service-info { flex: 1; }
        .note-preview { font-size: 0.75rem; color: var(--primary); margin-top: 5px; font-style: italic; display: block; }
        
        .status-area { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; }
        .pill-present { background: rgba(0, 255, 136, 0.15); color: var(--green); }
        .pill-absent { background: rgba(255, 75, 92, 0.15); color: var(--red); }

        .note-btn { background: var(--glass); border: 1px solid var(--border); color: white; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; border: 1px solid var(--border); }
        textarea { width: 100%; height: 120px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 12px; margin-bottom: 15px; }
        .btn-save-note { width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: var(--primary); text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-btn">‚Üê Back to Registry</a>

    <div class="profile-card">
        <img src="https://via.placeholder.com/100" class="profile-img" id="memberPic">
        <h1 id="memberName">Checking Access...</h1>
    </div>

    <div class="filter-box">
        <select id="timeFilter">
            <option value="all">All History</option>
            <option value="last-7">Last 7 Days</option>
            <option value="last-30">Last 30 Days</option>
        </select>
    </div>

    <div class="stats-row">
        <div class="stat-card"><span class="stat-val" id="totalServices">0</span><span class="stat-lab">Services</span></div>
        <div class="stat-card"><span class="stat-val" id="attRate">0%</span><span class="stat-lab">Attendance</span></div>
    </div>

    <div class="chart-box">
        <canvas id="attendanceChart"></canvas>
    </div>

    <div id="historyList" class="history-list">
        <p style="text-align:center; opacity:0.5;">Loading history...</p>
    </div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="color: var(--primary); margin-bottom:10px;">Note</h3>
        <textarea id="noteInput"></textarea>
        <button class="btn-save-note" id="saveNoteBtn">Save Note</button>
        <button onclick="document.getElementById('noteModal').style.display='none'" style="background:none; border:none; color:gray; width:100%; margin-top:10px; cursor:pointer;">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const memberId = urlParams.get('id');
    let myChart = null;

    // 1. AUTH CHECK: Only load if logged in
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadFullProfile();
        } else {
            window.location.href = "login.html";
        }
    });

    // 2. MAIN LOAD FUNCTION
    async function loadFullProfile(filter = "all") {
        if (!memberId) return;
        const historyDiv = document.getElementById('historyList');

        try {
            const mSnap = await getDoc(doc(db, "members", memberId));
            if (!mSnap.exists()) {
                document.getElementById('memberName').innerText = "Member not found";
                return;
            }
            document.getElementById('memberName').innerText = `${mSnap.data().first_name} ${mSnap.data().last_name}`;

            const eventsSnap = await getDocs(query(collection(db, "events"), orderBy("date", "desc")));
            historyDiv.innerHTML = "";
            
            let presentCount = 0;
            let displayedCount = 0;
            const today = new Date();

            for (const evDoc of eventsSnap.docs) {
                const ev = evDoc.data();
                const eventDate = new Date(ev.date);

                // Date Filtering
                if (filter === "last-7" && (today - eventDate) / 86400000 > 7) continue;
                if (filter === "last-30" && (today - eventDate) / 86400000 > 30) continue;

                displayedCount++;
                const attId = `${memberId}_${evDoc.id}`;
                const attSnap = await getDoc(doc(db, "attendance", attId));
                
                const isPresent = attSnap.exists() && attSnap.data().status === 'present';
                const note = attSnap.exists() ? (attSnap.data().note || "") : "";
                if(isPresent) presentCount++;

                historyDiv.innerHTML += `
                    <div class="history-item">
                        <div class="service-info">
                            <span style="font-weight:600">${ev.name}</span><br>
                            <small style="opacity:0.5">${ev.date}</small>
                            ${note ? `<span class="note-preview">üìù ${note}</span>` : ''}
                        </div>
                        <div class="status-area">
                            <span class="status-pill ${isPresent ? 'pill-present' : 'pill-absent'}">
                                ${isPresent ? 'PRESENT' : 'ABSENT'}
                            </span>
                            <div style="display:flex; gap:5px;">
                                <button class="note-btn" onclick="toggleStatus('${evDoc.id}', ${isPresent})">
                                    ${isPresent ? 'Mark Absent' : 'Mark Present'}
                                </button>
                                <button class="note-btn" onclick="openNote('${evDoc.id}', '${ev.name.replace(/'/g, "\\'")}', '${note.replace(/'/g, "\\'")}')">üí¨</button>
                            </div>
                        </div>
                    </div>`;
            }

            document.getElementById('totalServices').innerText = displayedCount;
            document.getElementById('attRate').innerText = `${displayedCount > 0 ? Math.round((presentCount / displayedCount) * 100) : 0}%`;
            renderChart(presentCount, displayedCount - presentCount);

        } catch (error) {
            console.error(error);
            historyDiv.innerHTML = `<p style="color:red; font-size:0.8rem">Error: Check Console for Index Link.</p>`;
        }
    }

    // 3. TOGGLE ATTENDANCE LOGIC
    window.toggleStatus = async (eventId, isCurrentlyPresent) => {
        const newStatus = isCurrentlyPresent ? 'absent' : 'present';
        const attRef = doc(db, "attendance", `${memberId}_${eventId}`);
        try {
            await setDoc(attRef, { 
                status: newStatus, 
                memberId: memberId, 
                eventId: eventId,
                lastUpdated: new Date()
            }, { merge: true });
            loadFullProfile(document.getElementById('timeFilter').value);
        } catch (e) { alert(e.message); }
    };

    // 4. CHART & NOTES
    function renderChart(present, absent) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Present', 'Absent'],
                datasets: [{ data: [present, absent], backgroundColor: ['#00ff88', '#ff4b5c'], borderColor: 'transparent' }]
            },
            options: { cutout: '75%', plugins: { legend: { display: false } } }
        });
    }

    window.openNote = (id, name, note) => {
        window.activeEventId = id;
        document.getElementById('modalTitle').innerText = name;
        document.getElementById('noteInput').value = note;
        document.getElementById('noteModal').style.display = 'flex';
    };

    document.getElementById('saveNoteBtn').onclick = async () => {
        const attRef = doc(db, "attendance", `${memberId}_${window.activeEventId}`);
        await setDoc(attRef, { note: document.getElementById('noteInput').value }, { merge: true });
        document.getElementById('noteModal').style.display = 'none';
        loadFullProfile(document.getElementById('timeFilter').value);
    };

    document.getElementById('timeFilter').onchange = (e) => loadFullProfile(e.target.value);
</script>
</body>
</html>
