<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Member Profile | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --green: #00ff88; --red: #ff4b5c;
        }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 50px; }

        /* Profile Header */
        .profile-card {
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 24px; border: 1px solid var(--border);
            text-align: center; margin-bottom: 20px;
        }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; background: #1e293b; }
        h1 { font-size: 1.4rem; margin-bottom: 5px; }
        .joined-date { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 15px; }

        /* Stats Grid */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--border); }
        .stat-val { display: block; font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-lab { font-size: 0.65rem; text-transform: uppercase; opacity: 0.6; }

        /* Chart Section */
        .chart-box { background: var(--glass); padding: 20px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        /* History List */
        .history-list { background: var(--glass); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
        .history-item { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            padding: 15px 0; border-bottom: 1px solid var(--border); 
        }
        .history-item:last-child { border-bottom: none; }
        .service-info { flex: 1; }
        .note-preview { font-size: 0.75rem; color: var(--primary); margin-top: 5px; font-style: italic; display: block; }
        
        .status-area { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; letter-spacing: 0.5px; }
        .pill-present { background: rgba(0, 255, 136, 0.15); color: var(--green); }
        .pill-absent { background: rgba(255, 75, 92, 0.15); color: var(--red); }

        .note-btn { background: var(--glass); border: 1px solid var(--border); color: white; padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .note-btn:hover { background: var(--primary); color: #000; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px); align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1e293b; padding: 25px; border-radius: 24px;
            width: 90%; max-width: 400px; border: 1px solid var(--border);
        }
        .modal-content h3 { margin-bottom: 15px; font-size: 1.1rem; color: var(--primary); }
        textarea {
            width: 100%; height: 120px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border); border-radius: 12px; color: white;
            padding: 12px; font-family: inherit; resize: none; outline: none; margin-bottom: 15px;
        }
        .modal-actions { display: flex; gap: 10px; }
        .btn-save-note { flex: 2; padding: 14px; background: var(--primary); border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .btn-close-note { flex: 1; padding: 14px; background: rgba(255,255,255,0.1); border: none; border-radius: 12px; color: white; cursor: pointer; }

        .back-btn { display: inline-block; margin-bottom: 20px; color: var(--primary); text-decoration: none; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-btn">‚Üê Back to Registry</a>

    <div class="profile-card">
        <img src="https://via.placeholder.com/100" class="profile-img" id="memberPic">
        <h1 id="memberName">Loading...</h1>
        <div class="joined-date" id="joinDate">Joined: --</div>
        <div id="pastorCredit" style="font-size: 0.8rem; color: var(--primary)"></div>
    </div>

    <div class="stats-row">
        <div class="stat-card"><span class="stat-val" id="totalServices">0</span><span class="stat-lab">Total Services</span></div>
        <div class="stat-card"><span class="stat-val" id="attRate">0%</span><span class="stat-lab">Attendance</span></div>
    </div>

    <div class="chart-box">
        <canvas id="attendanceChart"></canvas>
    </div>

    <h3 style="margin: 20px 0 15px; font-size: 1.1rem; padding-left: 5px;">Service History</h3>
    <div class="history-list" id="historyList">
        </div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Follow-up Note</h3>
        <textarea id="noteInput" placeholder="Why did they miss? Any updates?"></textarea>
        <div class="modal-actions">
            <button class="btn-close-note" id="closeModal">Cancel</button>
            <button class="btn-save-note" id="saveNoteBtn">Save Note</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");

    const urlParams = new URLSearchParams(window.location.search);
    const memberId = urlParams.get('id');
    let activeEventId = null;

    // --- MODAL LOGIC ---
    const modal = document.getElementById('noteModal');
    const noteInput = document.getElementById('noteInput');

    window.openNote = (eventId, eventName, currentNote) => {
        activeEventId = eventId;
        document.getElementById('modalTitle').innerText = `Note: ${eventName}`;
        noteInput.value = currentNote || "";
        modal.style.display = 'flex';
    };

    document.getElementById('closeModal').onclick = () => modal.style.display = 'none';

    document.getElementById('saveNoteBtn').onclick = async () => {
        if (!activeEventId) return;
        const btn = document.getElementById('saveNoteBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";

        try {
            const attRef = doc(db, "attendance", `${memberId}_${activeEventId}`);
            await setDoc(attRef, { note: noteInput.value }, { merge: true });
            modal.style.display = 'none';
            location.reload(); 
        } catch (e) {
            alert("Error: " + e.message);
            btn.disabled = false;
            btn.innerText = "Save Note";
        }
    };

    // --- DATA LOADING ---
    async function loadFullProfile() {
        if (!memberId) return;

        const mSnap = await getDoc(doc(db, "members", memberId));
        if (!mSnap.exists()) return;
        const m = mSnap.data();

        document.getElementById('memberName').innerText = `${m.first_name} ${m.last_name}`;
        document.getElementById('joinDate').innerText = `Joined: ${m.date_joined || '---'}`;
        if(m.profile_pic) document.getElementById('memberPic').src = m.profile_pic;

        const pSnap = await getDoc(doc(db, "pastors", m.pastorId));
        if(pSnap.exists()) document.getElementById('pastorCredit').innerText = `Under Pastor: ${pSnap.data().full_name}`;

        const eventsSnap = await getDocs(query(collection(db, "events"), orderBy("date", "desc")));
        const historyDiv = document.getElementById('historyList');
        
        let presentCount = 0;
        let totalCount = eventsSnap.docs.length;

        for (const evDoc of eventsSnap.docs) {
            const ev = evDoc.data();
            const evId = evDoc.id;
            const attSnap = await getDoc(doc(db, "attendance", `${memberId}_${evId}`));
            
            const isPresent = attSnap.exists() && attSnap.data().status === 'present';
            const note = attSnap.exists() ? (attSnap.data().note || "") : "";
            
            if(isPresent) presentCount++;

            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div class="service-info">
                    <span style="font-weight:600">${ev.name}</span><br>
                    <small style="opacity:0.5">${ev.date}</small>
                    ${note ? `<span class="note-preview">üìù ${note}</span>` : ''}
                </div>
                <div class="status-area">
                    <span class="status-pill ${isPresent ? 'pill-present' : 'pill-absent'}">
                        ${isPresent ? 'ATTENDED' : 'ABSENT'}
                    </span>
                    <button class="note-btn" onclick="openNote('${evId}', '${ev.name}', '${note.replace(/'/g, "\\'")}')">üí¨ Note</button>
                </div>
            `;
            historyDiv.appendChild(item);
        }

        document.getElementById('totalServices').innerText = totalCount;
        const rate = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
        document.getElementById('attRate').innerText = `${rate}%`;

        renderChart(presentCount, totalCount - presentCount);
    }

    function renderChart(present, absent) {
        new Chart(document.getElementById('attendanceChart'), {
            type: 'doughnut',
            data: {
                labels: ['Attended', 'Missed'],
                datasets: [{
                    data: [present, absent],
                    backgroundColor: ['#00ff88', '#ff4b5c'],
                    borderColor: 'transparent',
                    hoverOffset: 4
                }]
            },
            options: {
                cutout: '70%',
                plugins: { 
                    legend: { position: 'bottom', labels: { color: 'white', padding: 20, font: { family: 'Poppins' } } } 
                }
            }
        });
    }

    loadFullProfile();
</script>
</body>
</html>
