<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Member Profile | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="https://i.ibb.co/60bRQP5Z/Jewels-background-removed.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --green: #00ff88; --red: #ff4b5c; --neutral: #64748b;
        }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 50px; }
        .profile-card { background: var(--glass); backdrop-filter: blur(15px); padding: 30px; border-radius: 24px; border: 1px solid var(--border); text-align: center; margin-bottom: 20px; }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; background: #1e293b; }
        h1 { font-size: 1.4rem; margin-bottom: 5px; }
        .filter-box { margin-bottom: 20px; }
        select { width: 100%; padding: 12px; border-radius: 12px; background: #1e293b; color: white; border: 1px solid var(--border); outline: none; font-family: inherit; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--border); }
        .stat-val { display: block; font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-lab { font-size: 0.65rem; text-transform: uppercase; opacity: 0.6; }
        .chart-box { background: var(--glass); padding: 20px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
        .history-list { background: var(--glass); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
        .history-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 15px 0; border-bottom: 1px solid var(--border); transition: 0.3s; }
        .history-item:last-child { border-bottom: none; }
        .service-info { flex: 1; }
        .note-preview { font-size: 0.75rem; color: var(--primary); margin-top: 5px; font-style: italic; display: block; }
        .status-area { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; }
        .pill-present { background: rgba(0, 255, 136, 0.15); color: var(--green); }
        .pill-absent { background: rgba(255, 75, 92, 0.15); color: var(--red); }
        .pill-neutral { background: rgba(100, 116, 139, 0.15); color: var(--neutral); }
        
        .action-group { display: flex; gap: 6px; }
        .btn-action { 
            padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); 
            cursor: pointer; font-size: 0.75rem; font-weight: 700; transition: 0.2s;
            background: rgba(255,255,255,0.05); color: white;
        }
        .btn-action:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }
        .btn-p.active { background: var(--green); color: #0f172a; border-color: var(--green); box-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .btn-a.active { background: var(--red); color: white; border-color: var(--red); box-shadow: 0 0 10px rgba(255,75,92,0.3); }
        .note-btn { background: var(--glass); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 8px; cursor: pointer; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; border: 1px solid var(--border); }
        textarea { width: 100%; height: 120px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; color: white; padding: 12px; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; }
        .btn-save-note { width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: var(--primary); text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-btn">‚Üê Back to Registry</a>
    <div class="profile-card">
        <img src="https://via.placeholder.com/100" class="profile-img" id="memberPic">
        <h1 id="memberName">Loading Profile...</h1>
    </div>

    <div class="filter-box">
        <select id="timeFilter">
            <option value="all">Full 2026 Calendar</option>
            <optgroup label="2026 Months">
                <option value="2026-01">January</option><option value="2026-02">February</option>
                <option value="2026-03">March</option><option value="2026-04">April</option>
                <option value="2026-05">May</option><option value="2026-06">June</option>
                <option value="2026-07">July</option><option value="2026-08">August</option>
                <option value="2026-09">September</option><option value="2026-10">October</option>
                <option value="2026-11">November</option><option value="2026-12">December</option>
            </optgroup>
        </select>
    </div>

    <div class="stats-row">
        <div class="stat-card"><span class="stat-val" id="totalPastEvents">0</span><span class="stat-lab">Total Services Due</span></div>
        <div class="stat-card"><span class="stat-val" id="attRate">0%</span><span class="stat-lab">Att. Rate</span></div>
    </div>

    <div class="chart-box"><canvas id="attendanceChart"></canvas></div>
    <div id="historyList" class="history-list"></div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="color: var(--primary); margin-bottom:10px;">Note</h3>
        <textarea id="noteInput" placeholder="Enter follow-up details..."></textarea>
        <button class="btn-save-note" id="saveNoteBtn">Save Note</button>
        <button onclick="document.getElementById('noteModal').style.display='none'" style="background:none; border:none; color:gray; width:100%; margin-top:10px; cursor:pointer;">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");
    const auth = getAuth(app);
    const urlParams = new URLSearchParams(window.location.search);
    const memberId = urlParams.get('id');
    let myChart = null;

    onAuthStateChanged(auth, (user) => {
        if (user) loadFullProfile();
        else window.location.href = "login.html";
    });

    async function loadFullProfile() {
        if (!memberId) return;
        const filterValue = document.getElementById('timeFilter').value;
        const historyDiv = document.getElementById('historyList');

        try {
            const mSnap = await getDoc(doc(db, "members", memberId));
            if (mSnap.exists()) document.getElementById('memberName').innerText = `${mSnap.data().first_name} ${mSnap.data().last_name}`;

            const attDocs = await getDocs(query(collection(db, "attendance"), where("memberId", "==", memberId)));
            const attendanceMap = {};
            attDocs.forEach(d => attendanceMap[d.data().eventId] = d.data());

            const eventsSnap = await getDocs(query(collection(db, "events"), orderBy("date", "asc")));
            
            let presentCount = 0;
            let pastEventsCount = 0;
            let listHtml = "";

            const now = new Date();
            const todayGMT = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())).toISOString().split('T')[0];

            eventsSnap.forEach(evDoc => {
                const ev = evDoc.data();
                const attData = attendanceMap[evDoc.id] || {};
                const isPresent = attData.status === 'present';
                const isAbsent = attData.status === 'absent';
                
                const isDue = ev.date <= todayGMT;

                // MATH: Automatically counts as a 'miss' if isDue is true and isPresent is false
                if (isDue) {
                    pastEventsCount++;
                    if (isPresent) presentCount++;
                }

                if (filterValue === "all" || ev.date.startsWith(filterValue)) {
                    let pillClass = "pill-neutral";
                    let statusLabel = isDue ? "Unmarked" : "Locked üîí";
                    if (isPresent) { pillClass = "pill-present"; statusLabel = "Present"; }
                    else if (isAbsent) { pillClass = "pill-absent"; statusLabel = "Absent"; }

                    listHtml += `
                        <div class="history-item" style="${!isDue ? 'opacity:0.4' : ''}">
                            <div class="service-info">
                                <span style="font-weight:600">${ev.name}</span><br>
                                <small style="opacity:0.5">${ev.date}</small>
                                ${attData.note ? `<span class="note-preview">üìù ${attData.note}</span>` : ''}
                            </div>
                            <div class="status-area">
                                <span class="status-pill ${pillClass}">${statusLabel}</span>
                                <div class="action-group">
                                    <button class="btn-action btn-p ${isPresent ? 'active' : ''}" 
                                        onclick="updateStatus('${evDoc.id}', 'present')" ${!isDue ? 'disabled' : ''}>P</button>
                                    <button class="btn-action btn-a ${isAbsent ? 'active' : ''}" 
                                        onclick="updateStatus('${evDoc.id}', 'absent')" ${!isDue ? 'disabled' : ''}>A</button>
                                    <button class="note-btn" onclick="openNote('${evDoc.id}', '${ev.name.replace(/'/g, "\\'")}', '${(attData.note || "").replace(/'/g, "\\'")}')">üí¨</button>
                                </div>
                            </div>
                        </div>`;
                }
            });

            historyDiv.innerHTML = listHtml || "<p style='text-align:center; opacity:0.5;'>No events scheduled.</p>";
            document.getElementById('totalPastEvents').innerText = pastEventsCount;
            document.getElementById('attRate').innerText = `${pastEventsCount > 0 ? Math.round((presentCount / pastEventsCount) * 100) : 0}%`;
            renderChart(presentCount, pastEventsCount - presentCount);

        } catch (error) { console.error(error); }
    }

    window.updateStatus = async (eventId, newStatus) => {
        try {
            await setDoc(doc(db, "attendance", `${memberId}_${eventId}`), { 
                status: newStatus, memberId, eventId, lastUpdated: new Date()
            }, { merge: true });
            loadFullProfile();
        } catch (e) { alert(e.message); }
    };

    function renderChart(present, absent) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Present', 'Missed'],
                datasets: [{ data: [present, absent], backgroundColor: ['#00ff88', '#ff4b5c'], borderColor: 'transparent' }]
            },
            options: { cutout: '75%', plugins: { legend: { display: false } } }
        });
    }

    window.openNote = (id, name, note) => {
        window.activeEventId = id;
        document.getElementById('modalTitle').innerText = name;
        document.getElementById('noteInput').value = note;
        document.getElementById('noteModal').style.display = 'flex';
    };

    document.getElementById('saveNoteBtn').onclick = async () => {
        await setDoc(doc(db, "attendance", `${memberId}_${window.activeEventId}`), { 
            note: document.getElementById('noteInput').value, memberId, eventId: window.activeEventId 
        }, { merge: true });
        document.getElementById('noteModal').style.display = 'none';
        loadFullProfile();
    };

    document.getElementById('timeFilter').onchange = () => loadFullProfile();
</script>
</body>
</html>
