<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Events | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); --gold: #ffd700; }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; padding: 20px; }
        .card { background: var(--glass); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 450px; }
        h2 { color: var(--primary); margin-bottom: 5px; text-align: center; }
        p { text-align: center; font-size: 0.8rem; opacity: 0.6; margin-bottom: 25px; }
        
        .section-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--gold); margin-top: 20px; display: block; letter-spacing: 1px; }
        input, select, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: white; outline: none; box-sizing: border-box; }
        
        .btn-auto { background: linear-gradient(45deg, #4facfe, #00f2fe); color: #0f172a; font-weight: 600; cursor: pointer; border: none; }
        .btn-auto:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-special { background: transparent; border: 1px solid var(--primary); color: var(--primary); font-weight: 600; cursor: pointer; }
        .btn-special:hover { background: var(--primary); color: #000; }
        
        .back-link { display: block; text-align: center; color: var(--primary); text-decoration: none; font-size: 0.8rem; margin-top: 15px; }
        hr { border: 0; border-top: 1px solid var(--border); margin: 25px 0; }
    </style>
</head>
<body>

<div class="card">
    <h2>Event Manager</h2>
    <p>ShepherdNet Automation</p>

    <span class="section-label">System Automation</span>
    <button id="btnAutoGenerate" class="btn-auto">Auto-Generate 2026 Schedule</button>
    <small id="status-msg" style="font-size: 0.65rem; opacity: 0.5; display: block; text-align: center;">This will set all Sunday, Wednesday, Friday, Dawn, and Monthly events for 2026.</small>

    <hr>

    <span class="section-label">Create Special Event</span>
    <input type="text" id="specialEventName" placeholder="Event Name (e.g. Youth Camp)">
    <input type="date" id="specialEventDate">
    <select id="specialCategory">
        <option value="Special Event">Special Event</option>
        <option value="Conference">Conference</option>
        <option value="Vigil">Vigil</option>
    </select>
    <button id="btnCreateSpecial" class="btn-special">Add Special Event</button>

    <a href="index.html" class="back-link">‚Üê Back to Registry</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "fobrealdbase");
    const auth = getAuth(app);

    // Verify Auth State
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            alert("Unauthorized. Redirecting to login...");
            window.location.href = "../index.html";
        }
    });

    // --- 1. SPECIAL EVENT CREATION ---
    document.getElementById('btnCreateSpecial').onclick = async () => {
        const name = document.getElementById('specialEventName').value;
        const date = document.getElementById('specialEventDate').value;
        const cat = document.getElementById('specialCategory').value;

        if(!name || !date) return alert("Fill Name and Select Date");

        try {
            await addDoc(collection(db, "events"), {
                name: name,
                date: date,
                category: cat,
                timestamp: new Date(),
                createdBy: auth.currentUser.uid
            });
            alert("Special Event Created!");
            window.location.reload();
        } catch (e) { alert("Error: " + e.message); }
    };

    // --- 2. AUTO GENERATION LOGIC (BATCHED) ---
    document.getElementById('btnAutoGenerate').onclick = async () => {
        if(!confirm("Generate all recurring events for 2026? This will process in batches.")) return;
        
        const btn = document.getElementById('btnAutoGenerate');
        const msg = document.getElementById('status-msg');
        btn.innerText = "Processing...";
        btn.disabled = true;

        const start = new Date(2026, 0, 1); 
        const end = new Date(2026, 11, 31);
        
        let currentDate = new Date(start);
        const eventsList = [];

        // Build the list of events
        while (currentDate <= end) {
            const day = currentDate.getDay(); 
            const dateStr = currentDate.toISOString().split('T')[0];
            
            eventsList.push({ name: "Dawn Prayers", date: dateStr, category: "Daily" });

            if (day === 0) eventsList.push({ name: "Sunday Service", date: dateStr, category: "Sunday Service" });
            if (day === 3) eventsList.push({ name: "Wednesday Brake Fuel Prayers", date: dateStr, category: "Mid-Week" });
            if (day === 5) eventsList.push({ name: "Friday Freeflow", date: dateStr, category: "Mid-Week" });

            if (day === 6) {
                let nextWeek = new Date(currentDate);
                nextWeek.setDate(currentDate.getDate() + 7);
                if (nextWeek.getMonth() !== currentDate.getMonth()) {
                    eventsList.push({ name: "Prayer Secrets Conference", date: dateStr, category: "Conference" });
                }
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }

        try {
            // Firestore batches are limited to 500 writes
            const chunkSize = 400; 
            for (let i = 0; i < eventsList.length; i += chunkSize) {
                const batch = writeBatch(db);
                const chunk = eventsList.slice(i, i + chunkSize);
                
                chunk.forEach(ev => {
                    const newDocRef = doc(collection(db, "events"));
                    batch.set(newDocRef, { ...ev, timestamp: new Date(), createdBy: auth.currentUser.uid });
                });

                msg.innerText = `Saving batch ${Math.ceil((i+chunkSize)/chunkSize)}...`;
                await batch.commit();
            }

            alert(`Success! Generated ${eventsList.length} events.`);
            window.location.href = "index.html";
        } catch (e) { 
            alert("Batch Error: " + e.message); 
            btn.innerText = "Auto-Generate 2026 Schedule";
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
