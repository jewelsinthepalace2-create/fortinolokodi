<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registry | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-dim: rgba(255, 255, 255, 0.5);
            --green: #00ff88; --red: #ff4b5c; --sidebar-w: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; }

        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); width: var(--sidebar-w); height: 100%; background: #111827; border-right: 1px solid var(--border); z-index: 1000; transition: 0.3s; padding: 30px 20px; }
        .sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .nav-item { display: block; padding: 15px; color: white; text-decoration: none; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; }
        .nav-item.active { background: var(--primary); color: #0f172a; font-weight: 600; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 900; backdrop-filter: blur(4px); }
        .overlay.show { display: block; }

        .main-content { padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Search & Filter UI */
        .controls-container { margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; }
        .search-box { width: 100%; padding: 12px 15px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        
        /* Group Container */
        .pastor-group { margin-bottom: 30px; }
        .pastor-header { 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .pastor-header h3 { font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .pastor-badge { font-size: 0.65rem; background: var(--primary); color: #0f172a; padding: 2px 8px; border-radius: 20px; font-weight: 600; }

        /* Member Cards */
        .member-link { text-decoration: none; color: inherit; display: block; margin-bottom: 12px; }
        .member-card { background: var(--glass); border: 1px solid var(--border); border-radius: 18px; padding: 18px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .member-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.08); }
        .member-card.alert-danger { border-color: var(--red); animation: pulse-red 2s infinite; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0px rgba(255, 75, 92, 0.2); } 50% { box-shadow: 0 0 12px rgba(255, 75, 92, 0.4); } }

        .streak-container { display: flex; gap: 6px; margin-top: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .dot.present { background: var(--green); border: none; box-shadow: 0 0 8px var(--green); }
        .dot.absent { background: var(--red); border: none; box-shadow: 0 0 8px var(--red); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0f172a; text-decoration: none; font-size: 24px; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); z-index: 100; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; color: var(--primary);">ShepherdNet</h2>
    <a href="#" class="nav-item active">Registry</a>
    <a href="" id="dashLink" class="nav-item">Dashboard</a>
    <a href="../list/settings.html" class="nav-item">Settings</a>
    <hr style="opacity: 0.1; margin: 20px 0;">
    <a href="#" onclick="logout()" class="nav-item" style="color: var(--red);">Logout</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="main-content">
    <nav style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <button onclick="toggleMenu()" style="background:var(--glass); border:1px solid var(--border); color:white; padding:10px; border-radius:10px; cursor:pointer;">☰</button>
        <div style="text-align: right;">
            <h1 style="font-size: 1.2rem;">Registry</h1>
            <p id="roleInfo" style="font-size: 0.7rem; opacity: 0.6;">Connecting...</p>
        </div>
    </nav>

    <div class="controls-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search members...">
    </div>

    <div id="memberList"></div>
</div>

<a href="../dashboard/add-member.html" class="fab">+</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "fobrealdbase");

    let allMembers = [];
    let latestEvents = [];
    let pastorNames = {}; // Cache for pastor names

    window.toggleMenu = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    };

    window.logout = () => signOut(auth).then(() => window.location.href = "/index.html");

    async function fetchLatestEvents() {
        const todayStr = new Date().toISOString().split('T')[0];
        const q = query(collection(db, "events"), where("date", "<=", todayStr), orderBy("date", "desc"), limit(5));
        const snap = await getDocs(q);
        latestEvents = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
    }

    async function getAttendanceDots(memberId) {
        let dots = "";
        let absentCount = 0;
        for (const ev of latestEvents) {
            const attSnap = await getDoc(doc(db, "attendance", `${memberId}_${ev.id}`));
            let status = attSnap.exists() ? attSnap.data().status : 'unmarked';
            if (status !== 'present') absentCount++;
            dots += `<div class="dot ${status === 'unmarked' ? '' : status}" onclick="toggleAttendance(event, this, '${memberId}', '${ev.id}')"></div>`;
        }
        return { html: dots, isAtRisk: absentCount >= 3 };
    }

    async function renderList(members) {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = "";

        if (!members.length) {
            listDiv.innerHTML = "<p style='text-align:center; opacity:0.5;'>No members found.</p>";
            return;
        }

        // --- GROUPING LOGIC ---
        const groups = {};
        for (const m of members) {
            const pId = m.pastorId || "Unknown";
            if (!groups[pId]) groups[pId] = [];
            groups[pId].push(m);
        }

        for (const pId in groups) {
            const groupName = pastorNames[pId] || "External Pastor / Unassigned";
            const memberCount = groups[pId].length;

            const groupContainer = document.createElement('div');
            groupContainer.className = 'pastor-group';
            groupContainer.innerHTML = `
                <div class="pastor-header">
                    <h3>Pastor: ${groupName}</h3>
                    <span class="pastor-badge">${memberCount}</span>
                </div>
                <div id="members-of-${pId}"></div>
            `;
            listDiv.appendChild(groupContainer);

            const innerList = document.getElementById(`members-of-${pId}`);
            
            for (const m of groups[pId]) {
                const { html, isAtRisk } = await getAttendanceDots(m.id);
                innerList.innerHTML += `
                    <a href="profile.html?id=${m.id}" class="member-link">
                        <div class="member-card ${isAtRisk ? 'alert-danger' : ''}">
                            <div>
                                <div style="font-weight:600;">${m.first_name} ${m.last_name}</div>
                                <div style="font-size:0.65rem; color:var(--primary);">${m.job || 'Member'}</div>
                                <div class="streak-container">${html}</div>
                            </div>
                            <div style="opacity:0.2;">›</div>
                        </div>
                    </a>`;
            }
        }
    }

    function filterMembers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allMembers.filter(m => 
            `${m.first_name} ${m.last_name}`.toLowerCase().includes(searchTerm)
        );
        renderList(filtered);
    }

    document.getElementById('searchInput').oninput = filterMembers;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "../index.html"; return; }
        await fetchLatestEvents();
        
        const roles = ["master_admin", "pastors", "shepherds"];
        for (const role of roles) {
            const snap = await getDoc(doc(db, role, user.uid));
            if (snap.exists()) {
                document.getElementById('roleInfo').innerText = `${role.replace('_',' ')}: ${snap.data().full_name}`;
                
                const dashLink = document.getElementById('dashLink');
                dashLink.href = role === "master_admin" ? "../admin/index.html" : role === "pastors" ? "../pastor/index.html" : "../shepherd/index.html";

                // Fetch data
                let q = collection(db, "members");
                if (role === "pastors") q = query(q, where("pastorId", "==", user.uid));
                if (role === "shepherds") q = query(q, where("shepherdId", "==", user.uid));

                const memberSnap = await getDocs(q);
                allMembers = memberSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // --- FETCH PASTOR NAMES ---
                const pastorSnap = await getDocs(collection(db, "pastors"));
                pastorSnap.forEach(doc => {
                    pastorNames[doc.id] = doc.data().full_name;
                });

                renderList(allMembers);
                break;
            }
        }
    });

    window.toggleAttendance = async (event, dot, memberId, eventId) => {
        event.preventDefault(); event.stopPropagation();
        const attRef = doc(db, "attendance", `${memberId}_${eventId}`);
        if (!dot.classList.contains('present') && !dot.classList.contains('absent')) {
            await setDoc(attRef, { status: 'present', memberId, eventId });
            dot.className = 'dot present';
        } else if (dot.classList.contains('present')) {
            await setDoc(attRef, { status: 'absent', memberId, eventId });
            dot.className = 'dot absent';
        } else {
            await deleteDoc(attRef);
            dot.className = 'dot';
        }
    };
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registry | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-dim: rgba(255, 255, 255, 0.5);
            --green: #00ff88; --red: #ff4b5c; --sidebar-w: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; }

        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); width: var(--sidebar-w); height: 100%; background: #111827; border-right: 1px solid var(--border); z-index: 1000; transition: 0.3s; padding: 30px 20px; }
        .sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .nav-item { display: block; padding: 15px; color: white; text-decoration: none; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; }
        .nav-item.active { background: var(--primary); color: #0f172a; font-weight: 600; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 900; backdrop-filter: blur(4px); }
        .overlay.show { display: block; }

        .main-content { padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Search & Filter UI */
        .controls-container { margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; }
        .search-box { width: 100%; padding: 12px 15px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        
        /* Group Container */
        .pastor-group { margin-bottom: 30px; }
        .pastor-header { 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .pastor-header h3 { font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .pastor-badge { font-size: 0.65rem; background: var(--primary); color: #0f172a; padding: 2px 8px; border-radius: 20px; font-weight: 600; }

        /* Member Cards */
        .member-link { text-decoration: none; color: inherit; display: block; margin-bottom: 12px; }
        .member-card { background: var(--glass); border: 1px solid var(--border); border-radius: 18px; padding: 18px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .member-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.08); }
        .member-card.alert-danger { border-color: var(--red); animation: pulse-red 2s infinite; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0px rgba(255, 75, 92, 0.2); } 50% { box-shadow: 0 0 12px rgba(255, 75, 92, 0.4); } }

        .streak-container { display: flex; gap: 6px; margin-top: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .dot.present { background: var(--green); border: none; box-shadow: 0 0 8px var(--green); }
        .dot.absent { background: var(--red); border: none; box-shadow: 0 0 8px var(--red); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0f172a; text-decoration: none; font-size: 24px; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); z-index: 100; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; color: var(--primary);">ShepherdNet</h2>
    <a href="#" class="nav-item active">Registry</a>
    <a href="" id="dashLink" class="nav-item">Dashboard</a>
    <a href="../list/settings.html" class="nav-item">Settings</a>
    <hr style="opacity: 0.1; margin: 20px 0;">
    <a href="#" onclick="logout()" class="nav-item" style="color: var(--red);">Logout</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="main-content">
    <nav style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <button onclick="toggleMenu()" style="background:var(--glass); border:1px solid var(--border); color:white; padding:10px; border-radius:10px; cursor:pointer;">☰</button>
        <div style="text-align: right;">
            <h1 style="font-size: 1.2rem;">Registry</h1>
            <p id="roleInfo" style="font-size: 0.7rem; opacity: 0.6;">Connecting...</p>
        </div>
    </nav>

    <div class="controls-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search members...">
    </div>

    <div id="memberList"></div>
</div>

<a href="../dashboard/add-member.html" class="fab">+</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "fobrealdbase");

    let allMembers = [];
    let latestEvents = [];
    let pastorNames = {}; // Cache for pastor names

    window.toggleMenu = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    };

    window.logout = () => signOut(auth).then(() => window.location.href = "/index.html");

    async function fetchLatestEvents() {
        const todayStr = new Date().toISOString().split('T')[0];
        const q = query(collection(db, "events"), where("date", "<=", todayStr), orderBy("date", "desc"), limit(5));
        const snap = await getDocs(q);
        latestEvents = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
    }

    async function getAttendanceDots(memberId) {
        let dots = "";
        let absentCount = 0;
        for (const ev of latestEvents) {
            const attSnap = await getDoc(doc(db, "attendance", `${memberId}_${ev.id}`));
            let status = attSnap.exists() ? attSnap.data().status : 'unmarked';
            if (status !== 'present') absentCount++;
            dots += `<div class="dot ${status === 'unmarked' ? '' : status}" onclick="toggleAttendance(event, this, '${memberId}', '${ev.id}')"></div>`;
        }
        return { html: dots, isAtRisk: absentCount >= 3 };
    }

    async function renderList(members) {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = "";

        if (!members.length) {
            listDiv.innerHTML = "<p style='text-align:center; opacity:0.5;'>No members found.</p>";
            return;
        }

        // --- GROUPING LOGIC ---
        const groups = {};
        for (const m of members) {
            const pId = m.pastorId || "Unknown";
            if (!groups[pId]) groups[pId] = [];
            groups[pId].push(m);
        }

        for (const pId in groups) {
            const groupName = pastorNames[pId] || "External Pastor / Unassigned";
            const memberCount = groups[pId].length;

            const groupContainer = document.createElement('div');
            groupContainer.className = 'pastor-group';
            groupContainer.innerHTML = `
                <div class="pastor-header">
                    <h3>Pastor: ${groupName}</h3>
                    <span class="pastor-badge">${memberCount}</span>
                </div>
                <div id="members-of-${pId}"></div>
            `;
            listDiv.appendChild(groupContainer);

            const innerList = document.getElementById(`members-of-${pId}`);
            
            for (const m of groups[pId]) {
                const { html, isAtRisk } = await getAttendanceDots(m.id);
                innerList.innerHTML += `
                    <a href="profile.html?id=${m.id}" class="member-link">
                        <div class="member-card ${isAtRisk ? 'alert-danger' : ''}">
                            <div>
                                <div style="font-weight:600;">${m.first_name} ${m.last_name}</div>
                                <div style="font-size:0.65rem; color:var(--primary);">${m.job || 'Member'}</div>
                                <div class="streak-container">${html}</div>
                            </div>
                            <div style="opacity:0.2;">›</div>
                        </div>
                    </a>`;
            }
        }
    }

    function filterMembers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allMembers.filter(m => 
            `${m.first_name} ${m.last_name}`.toLowerCase().includes(searchTerm)
        );
        renderList(filtered);
    }

    document.getElementById('searchInput').oninput = filterMembers;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "../index.html"; return; }
        await fetchLatestEvents();
        
        const roles = ["master_admin", "pastors", "shepherds"];
        for (const role of roles) {
            const snap = await getDoc(doc(db, role, user.uid));
            if (snap.exists()) {
                document.getElementById('roleInfo').innerText = `${role.replace('_',' ')}: ${snap.data().full_name}`;
                
                const dashLink = document.getElementById('dashLink');
                dashLink.href = role === "master_admin" ? "../admin/index.html" : role === "pastors" ? "../pastor/index.html" : "../shepherd/index.html";

                // Fetch data
                let q = collection(db, "members");
                if (role === "pastors") q = query(q, where("pastorId", "==", user.uid));
                if (role === "shepherds") q = query(q, where("shepherdId", "==", user.uid));

                const memberSnap = await getDocs(q);
                allMembers = memberSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // --- FETCH PASTOR NAMES ---
                const pastorSnap = await getDocs(collection(db, "pastors"));
                pastorSnap.forEach(doc => {
                    pastorNames[doc.id] = doc.data().full_name;
                });

                renderList(allMembers);
                break;
            }
        }
    });

    window.toggleAttendance = async (event, dot, memberId, eventId) => {
        event.preventDefault(); event.stopPropagation();
        const attRef = doc(db, "attendance", `${memberId}_${eventId}`);
        if (!dot.classList.contains('present') && !dot.classList.contains('absent')) {
            await setDoc(attRef, { status: 'present', memberId, eventId });
            dot.className = 'dot present';
        } else if (dot.classList.contains('present')) {
            await setDoc(attRef, { status: 'absent', memberId, eventId });
            dot.className = 'dot absent';
        } else {
            await deleteDoc(attRef);
            dot.className = 'dot';
        }
    };
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registry | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-dim: rgba(255, 255, 255, 0.5);
            --green: #00ff88; --red: #ff4b5c; --sidebar-w: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; }

        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); width: var(--sidebar-w); height: 100%; background: #111827; border-right: 1px solid var(--border); z-index: 1000; transition: 0.3s; padding: 30px 20px; }
        .sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .nav-item { display: block; padding: 15px; color: white; text-decoration: none; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; }
        .nav-item.active { background: var(--primary); color: #0f172a; font-weight: 600; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 900; backdrop-filter: blur(4px); }
        .overlay.show { display: block; }

        .main-content { padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Search & Filter UI */
        .controls-container { margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; }
        .search-box { width: 100%; padding: 12px 15px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        
        /* Group Container */
        .pastor-group { margin-bottom: 30px; }
        .pastor-header { 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .pastor-header h3 { font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .pastor-badge { font-size: 0.65rem; background: var(--primary); color: #0f172a; padding: 2px 8px; border-radius: 20px; font-weight: 600; }

        /* Member Cards */
        .member-link { text-decoration: none; color: inherit; display: block; margin-bottom: 12px; }
        .member-card { background: var(--glass); border: 1px solid var(--border); border-radius: 18px; padding: 18px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .member-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.08); }
        .member-card.alert-danger { border-color: var(--red); animation: pulse-red 2s infinite; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0px rgba(255, 75, 92, 0.2); } 50% { box-shadow: 0 0 12px rgba(255, 75, 92, 0.4); } }

        .streak-container { display: flex; gap: 6px; margin-top: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .dot.present { background: var(--green); border: none; box-shadow: 0 0 8px var(--green); }
        .dot.absent { background: var(--red); border: none; box-shadow: 0 0 8px var(--red); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0f172a; text-decoration: none; font-size: 24px; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); z-index: 100; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; color: var(--primary);">ShepherdNet</h2>
    <a href="#" class="nav-item active">Registry</a>
    <a href="" id="dashLink" class="nav-item">Dashboard</a>
    <a href="../list/settings.html" class="nav-item">Settings</a>
    <hr style="opacity: 0.1; margin: 20px 0;">
    <a href="#" onclick="logout()" class="nav-item" style="color: var(--red);">Logout</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="main-content">
    <nav style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <button onclick="toggleMenu()" style="background:var(--glass); border:1px solid var(--border); color:white; padding:10px; border-radius:10px; cursor:pointer;">☰</button>
        <div style="text-align: right;">
            <h1 style="font-size: 1.2rem;">Registry</h1>
            <p id="roleInfo" style="font-size: 0.7rem; opacity: 0.6;">Connecting...</p>
        </div>
    </nav>

    <div class="controls-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search members...">
    </div>

    <div id="memberList"></div>
</div>

<a href="../dashboard/add-member.html" class="fab">+</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "fobrealdbase");

    let allMembers = [];
    let latestEvents = [];
    let pastorNames = {}; // Cache for pastor names

    window.toggleMenu = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    };

    window.logout = () => signOut(auth).then(() => window.location.href = "/index.html");

    async function fetchLatestEvents() {
        const todayStr = new Date().toISOString().split('T')[0];
        const q = query(collection(db, "events"), where("date", "<=", todayStr), orderBy("date", "desc"), limit(5));
        const snap = await getDocs(q);
        latestEvents = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
    }

    async function getAttendanceDots(memberId) {
        let dots = "";
        let absentCount = 0;
        for (const ev of latestEvents) {
            const attSnap = await getDoc(doc(db, "attendance", `${memberId}_${ev.id}`));
            let status = attSnap.exists() ? attSnap.data().status : 'unmarked';
            if (status !== 'present') absentCount++;
            dots += `<div class="dot ${status === 'unmarked' ? '' : status}" onclick="toggleAttendance(event, this, '${memberId}', '${ev.id}')"></div>`;
        }
        return { html: dots, isAtRisk: absentCount >= 3 };
    }

    async function renderList(members) {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = "";

        if (!members.length) {
            listDiv.innerHTML = "<p style='text-align:center; opacity:0.5;'>No members found.</p>";
            return;
        }

        // --- GROUPING LOGIC ---
        const groups = {};
        for (const m of members) {
            const pId = m.pastorId || "Unknown";
            if (!groups[pId]) groups[pId] = [];
            groups[pId].push(m);
        }

        for (const pId in groups) {
            const groupName = pastorNames[pId] || "External Pastor / Unassigned";
            const memberCount = groups[pId].length;

            const groupContainer = document.createElement('div');
            groupContainer.className = 'pastor-group';
            groupContainer.innerHTML = `
                <div class="pastor-header">
                    <h3>Pastor: ${groupName}</h3>
                    <span class="pastor-badge">${memberCount}</span>
                </div>
                <div id="members-of-${pId}"></div>
            `;
            listDiv.appendChild(groupContainer);

            const innerList = document.getElementById(`members-of-${pId}`);
            
            for (const m of groups[pId]) {
                const { html, isAtRisk } = await getAttendanceDots(m.id);
                innerList.innerHTML += `
                    <a href="profile.html?id=${m.id}" class="member-link">
                        <div class="member-card ${isAtRisk ? 'alert-danger' : ''}">
                            <div>
                                <div style="font-weight:600;">${m.first_name} ${m.last_name}</div>
                                <div style="font-size:0.65rem; color:var(--primary);">${m.job || 'Member'}</div>
                                <div class="streak-container">${html}</div>
                            </div>
                            <div style="opacity:0.2;">›</div>
                        </div>
                    </a>`;
            }
        }
    }

    function filterMembers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allMembers.filter(m => 
            `${m.first_name} ${m.last_name}`.toLowerCase().includes(searchTerm)
        );
        renderList(filtered);
    }

    document.getElementById('searchInput').oninput = filterMembers;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "../index.html"; return; }
        await fetchLatestEvents();
        
        const roles = ["master_admin", "pastors", "shepherds"];
        for (const role of roles) {
            const snap = await getDoc(doc(db, role, user.uid));
            if (snap.exists()) {
                document.getElementById('roleInfo').innerText = `${role.replace('_',' ')}: ${snap.data().full_name}`;
                
                const dashLink = document.getElementById('dashLink');
                dashLink.href = role === "master_admin" ? "../admin/index.html" : role === "pastors" ? "../pastor/index.html" : "../shepherd/index.html";

                // Fetch data
                let q = collection(db, "members");
                if (role === "pastors") q = query(q, where("pastorId", "==", user.uid));
                if (role === "shepherds") q = query(q, where("shepherdId", "==", user.uid));

                const memberSnap = await getDocs(q);
                allMembers = memberSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // --- FETCH PASTOR NAMES ---
                const pastorSnap = await getDocs(collection(db, "pastors"));
                pastorSnap.forEach(doc => {
                    pastorNames[doc.id] = doc.data().full_name;
                });

                renderList(allMembers);
                break;
            }
        }
    });

    window.toggleAttendance = async (event, dot, memberId, eventId) => {
        event.preventDefault(); event.stopPropagation();
        const attRef = doc(db, "attendance", `${memberId}_${eventId}`);
        if (!dot.classList.contains('present') && !dot.classList.contains('absent')) {
            await setDoc(attRef, { status: 'present', memberId, eventId });
            dot.className = 'dot present';
        } else if (dot.classList.contains('present')) {
            await setDoc(attRef, { status: 'absent', memberId, eventId });
            dot.className = 'dot absent';
        } else {
            await deleteDoc(attRef);
            dot.className = 'dot';
        }
    };
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registry | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-dim: rgba(255, 255, 255, 0.5);
            --green: #00ff88; --red: #ff4b5c; --sidebar-w: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; }

        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); width: var(--sidebar-w); height: 100%; background: #111827; border-right: 1px solid var(--border); z-index: 1000; transition: 0.3s; padding: 30px 20px; }
        .sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .nav-item { display: block; padding: 15px; color: white; text-decoration: none; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; }
        .nav-item.active { background: var(--primary); color: #0f172a; font-weight: 600; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 900; backdrop-filter: blur(4px); }
        .overlay.show { display: block; }

        .main-content { padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Search & Filter UI */
        .controls-container { margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; }
        .search-box { width: 100%; padding: 12px 15px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        
        /* Group Container */
        .pastor-group { margin-bottom: 30px; }
        .pastor-header { 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .pastor-header h3 { font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .pastor-badge { font-size: 0.65rem; background: var(--primary); color: #0f172a; padding: 2px 8px; border-radius: 20px; font-weight: 600; }

        /* Member Cards */
        .member-link { text-decoration: none; color: inherit; display: block; margin-bottom: 12px; }
        .member-card { background: var(--glass); border: 1px solid var(--border); border-radius: 18px; padding: 18px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .member-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.08); }
        .member-card.alert-danger { border-color: var(--red); animation: pulse-red 2s infinite; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0px rgba(255, 75, 92, 0.2); } 50% { box-shadow: 0 0 12px rgba(255, 75, 92, 0.4); } }

        .streak-container { display: flex; gap: 6px; margin-top: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .dot.present { background: var(--green); border: none; box-shadow: 0 0 8px var(--green); }
        .dot.absent { background: var(--red); border: none; box-shadow: 0 0 8px var(--red); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0f172a; text-decoration: none; font-size: 24px; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); z-index: 100; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; color: var(--primary);">ShepherdNet</h2>
    <a href="#" class="nav-item active">Registry</a>
    <a href="" id="dashLink" class="nav-item">Dashboard</a>
    <a href="../list/settings.html" class="nav-item">Settings</a>
    <hr style="opacity: 0.1; margin: 20px 0;">
    <a href="#" onclick="logout()" class="nav-item" style="color: var(--red);">Logout</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="main-content">
    <nav style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <button onclick="toggleMenu()" style="background:var(--glass); border:1px solid var(--border); color:white; padding:10px; border-radius:10px; cursor:pointer;">☰</button>
        <div style="text-align: right;">
            <h1 style="font-size: 1.2rem;">Registry</h1>
            <p id="roleInfo" style="font-size: 0.7rem; opacity: 0.6;">Connecting...</p>
        </div>
    </nav>

    <div class="controls-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search members...">
    </div>

    <div id="memberList"></div>
</div>

<a href="../dashboard/add-member.html" class="fab">+</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "fobrealdbase");

    let allMembers = [];
    let latestEvents = [];
    let pastorNames = {}; // Cache for pastor names

    window.toggleMenu = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    };

    window.logout = () => signOut(auth).then(() => window.location.href = "/index.html");

    async function fetchLatestEvents() {
        const todayStr = new Date().toISOString().split('T')[0];
        const q = query(collection(db, "events"), where("date", "<=", todayStr), orderBy("date", "desc"), limit(5));
        const snap = await getDocs(q);
        latestEvents = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
    }

    async function getAttendanceDots(memberId) {
        let dots = "";
        let absentCount = 0;
        for (const ev of latestEvents) {
            const attSnap = await getDoc(doc(db, "attendance", `${memberId}_${ev.id}`));
            let status = attSnap.exists() ? attSnap.data().status : 'unmarked';
            if (status !== 'present') absentCount++;
            dots += `<div class="dot ${status === 'unmarked' ? '' : status}" onclick="toggleAttendance(event, this, '${memberId}', '${ev.id}')"></div>`;
        }
        return { html: dots, isAtRisk: absentCount >= 3 };
    }

    async function renderList(members) {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = "";

        if (!members.length) {
            listDiv.innerHTML = "<p style='text-align:center; opacity:0.5;'>No members found.</p>";
            return;
        }

        // --- GROUPING LOGIC ---
        const groups = {};
        for (const m of members) {
            const pId = m.pastorId || "Unknown";
            if (!groups[pId]) groups[pId] = [];
            groups[pId].push(m);
        }

        for (const pId in groups) {
            const groupName = pastorNames[pId] || "External Pastor / Unassigned";
            const memberCount = groups[pId].length;

            const groupContainer = document.createElement('div');
            groupContainer.className = 'pastor-group';
            groupContainer.innerHTML = `
                <div class="pastor-header">
                    <h3>Pastor: ${groupName}</h3>
                    <span class="pastor-badge">${memberCount}</span>
                </div>
                <div id="members-of-${pId}"></div>
            `;
            listDiv.appendChild(groupContainer);

            const innerList = document.getElementById(`members-of-${pId}`);
            
            for (const m of groups[pId]) {
                const { html, isAtRisk } = await getAttendanceDots(m.id);
                innerList.innerHTML += `
                    <a href="profile.html?id=${m.id}" class="member-link">
                        <div class="member-card ${isAtRisk ? 'alert-danger' : ''}">
                            <div>
                                <div style="font-weight:600;">${m.first_name} ${m.last_name}</div>
                                <div style="font-size:0.65rem; color:var(--primary);">${m.job || 'Member'}</div>
                                <div class="streak-container">${html}</div>
                            </div>
                            <div style="opacity:0.2;">›</div>
                        </div>
                    </a>`;
            }
        }
    }

    function filterMembers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allMembers.filter(m => 
            `${m.first_name} ${m.last_name}`.toLowerCase().includes(searchTerm)
        );
        renderList(filtered);
    }

    document.getElementById('searchInput').oninput = filterMembers;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "../index.html"; return; }
        await fetchLatestEvents();
        
        const roles = ["master_admin", "pastors", "shepherds"];
        for (const role of roles) {
            const snap = await getDoc(doc(db, role, user.uid));
            if (snap.exists()) {
                document.getElementById('roleInfo').innerText = `${role.replace('_',' ')}: ${snap.data().full_name}`;
                
                const dashLink = document.getElementById('dashLink');
                dashLink.href = role === "master_admin" ? "../admin/index.html" : role === "pastors" ? "../pastor/index.html" : "../shepherd/index.html";

                // Fetch data
                let q = collection(db, "members");
                if (role === "pastors") q = query(q, where("pastorId", "==", user.uid));
                if (role === "shepherds") q = query(q, where("shepherdId", "==", user.uid));

                const memberSnap = await getDocs(q);
                allMembers = memberSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // --- FETCH PASTOR NAMES ---
                const pastorSnap = await getDocs(collection(db, "pastors"));
                pastorSnap.forEach(doc => {
                    pastorNames[doc.id] = doc.data().full_name;
                });

                renderList(allMembers);
                break;
            }
        }
    });

    window.toggleAttendance = async (event, dot, memberId, eventId) => {
        event.preventDefault(); event.stopPropagation();
        const attRef = doc(db, "attendance", `${memberId}_${eventId}`);
        if (!dot.classList.contains('present') && !dot.classList.contains('absent')) {
            await setDoc(attRef, { status: 'present', memberId, eventId });
            dot.className = 'dot present';
        } else if (dot.classList.contains('present')) {
            await setDoc(attRef, { status: 'absent', memberId, eventId });
            dot.className = 'dot absent';
        } else {
            await deleteDoc(attRef);
            dot.className = 'dot';
        }
    };
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registry | ShepherdNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-dim: rgba(255, 255, 255, 0.5);
            --green: #00ff88; --red: #ff4b5c; --sidebar-w: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; }

        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); width: var(--sidebar-w); height: 100%; background: #111827; border-right: 1px solid var(--border); z-index: 1000; transition: 0.3s; padding: 30px 20px; }
        .sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .nav-item { display: block; padding: 15px; color: white; text-decoration: none; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; }
        .nav-item.active { background: var(--primary); color: #0f172a; font-weight: 600; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 900; backdrop-filter: blur(4px); }
        .overlay.show { display: block; }

        .main-content { padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Search & Filter UI */
        .controls-container { margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; }
        .search-box { width: 100%; padding: 12px 15px; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        
        /* Group Container */
        .pastor-group { margin-bottom: 30px; }
        .pastor-header { 
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .pastor-header h3 { font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .pastor-badge { font-size: 0.65rem; background: var(--primary); color: #0f172a; padding: 2px 8px; border-radius: 20px; font-weight: 600; }

        /* Member Cards */
        .member-link { text-decoration: none; color: inherit; display: block; margin-bottom: 12px; }
        .member-card { background: var(--glass); border: 1px solid var(--border); border-radius: 18px; padding: 18px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .member-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.08); }
        .member-card.alert-danger { border-color: var(--red); animation: pulse-red 2s infinite; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0px rgba(255, 75, 92, 0.2); } 50% { box-shadow: 0 0 12px rgba(255, 75, 92, 0.4); } }

        .streak-container { display: flex; gap: 6px; margin-top: 10px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .dot.present { background: var(--green); border: none; box-shadow: 0 0 8px var(--green); }
        .dot.absent { background: var(--red); border: none; box-shadow: 0 0 8px var(--red); }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0f172a; text-decoration: none; font-size: 24px; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); z-index: 100; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h2 style="margin-bottom: 30px; color: var(--primary);">ShepherdNet</h2>
    <a href="#" class="nav-item active">Registry</a>
    <a href="" id="dashLink" class="nav-item">Dashboard</a>
    <a href="../list/settings.html" class="nav-item">Settings</a>
    <hr style="opacity: 0.1; margin: 20px 0;">
    <a href="#" onclick="logout()" class="nav-item" style="color: var(--red);">Logout</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="main-content">
    <nav style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <button onclick="toggleMenu()" style="background:var(--glass); border:1px solid var(--border); color:white; padding:10px; border-radius:10px; cursor:pointer;">☰</button>
        <div style="text-align: right;">
            <h1 style="font-size: 1.2rem;">Registry</h1>
            <p id="roleInfo" style="font-size: 0.7rem; opacity: 0.6;">Connecting...</p>
        </div>
    </nav>

    <div class="controls-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search members...">
    </div>

    <div id="memberList"></div>
</div>

<a href="../dashboard/add-member.html" class="fab">+</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc",
        authDomain: "fob-database-139d1.firebaseapp.com",
        projectId: "fob-database-139d1",
        storageBucket: "fob-database-139d1.firebasestorage.app",
        appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app, "fobrealdbase");

    let allMembers = [];
    let latestEvents = [];
    let pastorNames = {}; 
    let shepherdNames = {};
    let currentUserRole = "";

    window.toggleMenu = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    };

    window.logout = () => signOut(auth).then(() => window.location.href = "/index.html");

    async function fetchLatestEvents() {
        const todayStr = new Date().toISOString().split('T')[0];
        const q = query(collection(db, "events"), where("date", "<=", todayStr), orderBy("date", "desc"), limit(5));
        const snap = await getDocs(q);
        latestEvents = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
    }

    async function getAttendanceDots(memberId) {
        let dots = "";
        let absentCount = 0;
        for (const ev of latestEvents) {
            const attSnap = await getDoc(doc(db, "attendance", `${memberId}_${ev.id}`));
            let status = attSnap.exists() ? attSnap.data().status : 'unmarked';
            if (status !== 'present') absentCount++;
            dots += `<div class="dot ${status === 'unmarked' ? '' : status}" onclick="toggleAttendance(event, this, '${memberId}', '${ev.id}')"></div>`;
        }
        return { html: dots, isAtRisk: absentCount >= 3 };
    }

    async function renderList(members) {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = "";

        if (!members.length) {
            listDiv.innerHTML = "<p style='text-align:center; opacity:0.5;'>No members found.</p>";
            return;
        }

        // --- DYNAMIC GROUPING ---
        const groups = {};
        members.forEach(m => {
            // Master/Pastor views group by Pastor. Shepherd views group by Shepherd.
            let groupId = currentUserRole === "shepherds" ? (m.shepherdId || "none") : (m.pastorId || "none");
            if (!groups[groupId]) groups[groupId] = [];
            groups[groupId].push(m);
        });

        for (const gId in groups) {
            let groupDisplayName = "";
            if (currentUserRole === "shepherds") {
                groupDisplayName = `Shepherd: ${shepherdNames[gId] || "Direct Member"}`;
            } else {
                groupDisplayName = `Pastor: ${pastorNames[gId] || "Unassigned"}`;
            }

            const groupContainer = document.createElement('div');
            groupContainer.className = 'pastor-group';
            groupContainer.innerHTML = `
                <div class="pastor-header">
                    <h3>${groupDisplayName}</h3>
                    <span class="pastor-badge">${groups[gId].length}</span>
                </div>
                <div id="members-of-${gId}"></div>
            `;
            listDiv.appendChild(groupContainer);

            const innerList = document.getElementById(`members-of-${gId}`);
            
            for (const m of groups[gId]) {
                const { html, isAtRisk } = await getAttendanceDots(m.id);
                // We show the Shepherd's Name as a sub-label if an Admin/Pastor is looking
                const subLabel = currentUserRole !== "shepherds" ? 
                    `<div style="font-size:0.6rem; color:var(--text-dim);">Shepherd: ${shepherdNames[m.shepherdId] || 'None'}</div>` : '';

                innerList.innerHTML += `
                    <a href="profile.html?id=${m.id}" class="member-link">
                        <div class="member-card ${isAtRisk ? 'alert-danger' : ''}">
                            <div>
                                <div style="font-weight:600;">${m.first_name} ${m.last_name}</div>
                                <div style="font-size:0.65rem; color:var(--primary);">${m.job || 'Member'}</div>
                                ${subLabel}
                                <div class="streak-container">${html}</div>
                            </div>
                            <div style="opacity:0.2;">›</div>
                        </div>
                    </a>`;
            }
        }
    }

    function filterMembers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allMembers.filter(m => 
            `${m.first_name} ${m.last_name}`.toLowerCase().includes(searchTerm)
        );
        renderList(filtered);
    }

    document.getElementById('searchInput').oninput = filterMembers;

 onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "/index.html"; return; }
    await fetchLatestEvents();
    
    // 1. Fetch Master Admin Names Cache
    const masterSnap = await getDocs(collection(db, "master_admin"));
    masterSnap.forEach(d => pastorNames[d.id] = d.data().full_name); // Mapping admin to pastorNames for grouping

    // 2. Fetch Pastor Names Cache
    const pastorSnap = await getDocs(collection(db, "pastors"));
    pastorSnap.forEach(d => pastorNames[d.id] = d.data().full_name);

    // 3. Fetch Shepherd Names Cache
    const shepherdSnap = await getDocs(collection(db, "shepherds"));
    shepherdSnap.forEach(d => shepherdNames[d.id] = d.data().full_name);

    // 4. Role-based Member Fetching
    const roles = ["master_admin", "pastors", "shepherds"];
    for (const role of roles) {
        const snap = await getDoc(doc(db, role, user.uid));
        if (snap.exists()) {
            currentUserRole = role;
            document.getElementById('roleInfo').innerText = `${role.replace('_',' ')}: ${snap.data().full_name}`;
            
            const dashLink = document.getElementById('dashLink');
            // Unified dashboard routing
            dashLink.href = role === "master_admin" ? "../admin/index.html" : 
                            role === "pastors" ? "../pastor/index.html" : 
                            "../shepherd/index.html";

            let q = collection(db, "members");
            // If Pastor or Shepherd, filter results. If Master Admin, fetch everything.
            if (role === "pastors") q = query(q, where("pastorId", "==", user.uid));
            if (role === "shepherds") q = query(q, where("shepherdId", "==", user.uid));

            const memberSnap = await getDocs(q);
            allMembers = memberSnap.docs.map(d => ({ id: d.id, ...d.data() }));

            renderList(allMembers);
            break;
        }
    }
});

    window.toggleAttendance = async (event, dot, memberId, eventId) => {
        event.preventDefault(); event.stopPropagation();
        const attRef = doc(db, "attendance", `${memberId}_${eventId}`);
        if (!dot.classList.contains('present') && !dot.classList.contains('absent')) {
            await setDoc(attRef, { status: 'present', memberId, eventId });
            dot.className = 'dot present';
        } else if (dot.classList.contains('present')) {
            await setDoc(attRef, { status: 'absent', memberId, eventId });
            dot.className = 'dot absent';
        } else {
            await deleteDoc(attRef);
            dot.className = 'dot';
        }
    };
</script>
</body>
</html>
