<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Member | ShepherdNet</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/60bRQP5Z/Jewels-background-removed.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.07); }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body { 
      background: var(--bg); 
      color: white; 
      font-family: 'Poppins', sans-serif; 
      display: flex; 
      justify-content: center; 
      align-items: flex-start; /* Better for scrolling on mobile */
      padding: 20px; 
      min-height: 100vh; 
    }

    .card { 
      background: var(--glass); 
      padding: 30px; 
      border-radius: 20px; 
      width: 100%; 
      max-width: 480px; 
      backdrop-filter: blur(20px); 
      border: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      flex-direction: column;
      align-items: center; /* Centralizes all children */
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    h2 { color: var(--primary); font-weight: 600; margin-bottom: 5px; text-align: center; }
    #roleDisplay { font-size: 0.8rem; color: #888; margin-bottom: 25px; text-align: center; }

    .section-label { 
      width: 100%;
      font-size: 0.7rem; 
      text-transform: uppercase; 
      letter-spacing: 2px; 
      color: var(--primary); 
      margin: 20px 0 10px 0; 
      text-align: left;
      opacity: 0.8;
    }

    /* Centralizing input containers */
    .form-group { width: 100%; }

    input, select, textarea { 
      width: 100%; 
      padding: 14px; 
      margin: 8px 0; 
      background: rgba(0, 0, 0, 0.3); /* Darker background for better text visibility */
      border: 1px solid rgba(255, 255, 255, 0.2); 
      color: white; 
      border-radius: 12px; 
      outline: none; 
      font-size: 1rem;
      appearance: none; /* Removes default browser styling */
    }

    /* FIX FOR INVISIBLE DROPDOWNS */
    select option {
      background-color: #1e293b !important; /* Forces a dark, solid background */
      color: white !important;
      padding: 10px;
    }

    input:focus, select:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }

    .row { display: flex; gap: 10px; width: 100%; }
    .row > * { flex: 1; }

    button { 
      width: 100%; 
      padding: 18px; 
      background: linear-gradient(45deg, #4facfe, #00f2fe); 
      border: none; 
      border-radius: 12px; 
      color: #0f172a; 
      font-weight: 600; 
      cursor: pointer; 
      margin-top: 30px; 
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #msg { text-align: center; margin-top: 20px; font-weight: 400; }
  </style>
</head>
<body>

<div class="card">
  <h2>Add New Member</h2>
  <p id="roleDisplay">Identifying Account Role...</p>

  <div class="form-group">
    <div class="section-label">Member Photo</div>
<input type="file" id="mPhotoFile" accept="image/*" style="padding: 10px;">
    <div class="section-label">Identity</div>
    <input type="text" id="mSurname" placeholder="Surname (Last Name)" required>
    <div class="row">
        <input type="text" id="mFirstname" placeholder="First Name" required>
        <input type="text" id="mOthername" placeholder="Other Names (Optional)">
    </div>
    
    <div class="row">
      <select id="mGender" required>
        <option value="" disabled selected>Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
      <div style="flex: 1.5;">
        <label style="font-size: 0.6rem; color: #888; margin-left: 5px;">Date of Birth (GMT)</label>
        <input type="date" id="mBirthday" onchange="calculateAge()">
      </div>
    </div>
    <p id="ageDisplay" style="font-size: 0.75rem; color: var(--primary); margin-top: -5px; margin-left: 5px;"></p>

    <div class="section-label">Unique Contact</div>
    <input type="tel" id="mPhone" placeholder="Ghana Phone (0XX...)">
    <div id="phoneErr" class="error-text" style="color:#ff6b6b; font-size: 0.75rem; display:none;">Invalid Number or Already Exists</div>
    <input type="text" id="mHostel" placeholder="Hostel / Residential Address">

    <div class="section-label">Education & Status</div>
    <input type="text" id="mCourse" placeholder="Course of Study">
    <select id="mLevel">
        <option value="" selected disabled>Education Level</option>
        <option value="Level 100">Level 100</option>
        <option value="Level 200">Level 200</option>
        <option value="Level 300">Level 300</option>
        <option value="Level 400">Level 400</option>
        <option value="Level 500">Level 500</option>
        <option value="Level 600">Level 600</option>
        <option value="Alumnus">Alumnus</option>
        <option value="Non-Student">Non-Student</option>
    </select>

    <div class="row">
      <select id="mStatus">
        <option value="New Convert">New Convert</option>
        <option value="Established Member">Established Member</option>
      </select>
    </div>

    <div class="section-label">Emergency</div>
    <input type="text" id="mEmergencyName" placeholder="Next of Kin Name">
    <input type="tel" id="mEmergencyPhone" placeholder="Next of Kin Phone">
  </div>

  <button id="saveBtn" disabled>Checking Permissions...</button>
  <p id="msg"></p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs 
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  // Added Storage imports
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", 
    authDomain: "fob-database-139d1.firebaseapp.com", 
    projectId: "fob-database-139d1", 
    storageBucket: "fob-database-139d1.firebasestorage.app", 
    messagingSenderId: "375165731354", 
    appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" 
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app, "fobrealdbase");
  const storage = getStorage(app); // Initialize Storage

  let pId = null;
  let sId = null;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const roleDisplay = document.getElementById('roleDisplay');
      const saveBtn = document.getElementById('saveBtn');
      try {
        const shepherdRef = doc(db, "shepherds", user.uid);
        const pastorRef = doc(db, "pastors", user.uid);
        const adminRef = doc(db, "master_admin", user.uid); // Added Admin Ref

        const [shepSnap, pastSnap, adminSnap] = await Promise.all([
          getDoc(shepherdRef), 
          getDoc(pastorRef),
          getDoc(adminRef) // Added Admin Snap
        ]);

        if (shepSnap.exists()) {
          sId = user.uid;
          pId = shepSnap.data().assigned_pastor_id || "not_assigned";
          roleDisplay.innerText = `Logged in as Shepherd: ${shepSnap.data().full_name}`;
        } else if (pastSnap.exists()) {
          pId = user.uid;
          sId = "direct_pastor_entry";
          roleDisplay.innerText = `Logged in as Pastor: ${pastSnap.data().full_name}`;
        } else if (adminSnap.exists()) {
          // Master Admin Logic
          pId = user.uid; 
          sId = "master_admin_entry";
          roleDisplay.innerText = `Logged in as Master Admin: ${adminSnap.data().full_name}`;
        } else {
          roleDisplay.innerText = "Error: Role not found.";
          return;
        }
        
        saveBtn.disabled = false;
        saveBtn.innerText = "Save Member Data";
      } catch (err) {
        console.error(err);
        roleDisplay.innerText = "Connection Error.";
      }
    } else {
      window.location.href = "login.html";
    }
  });

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const phone = document.getElementById('mPhone').value.trim();
    const photoFile = document.getElementById('mPhotoFile').files[0];
    if(!phone) { alert("Phone number is required"); return; }
    
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; 
    btn.textContent = "Processing...";
    
    try {
      // 1. Duplicate Check
      const q = query(collection(db, "members"), where("phone", "==", phone));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
          alert("Duplicate Phone Number!");
          btn.disabled = false;
          return;
      }

      // 2. Handle Photo Upload (If selected)
      let photoUrl = null;
      if (photoFile) {
        btn.textContent = "Uploading Photo...";
        const storageRef = ref(storage, `member_photos/${phone}_${Date.now()}`);
        await uploadBytes(storageRef, photoFile);
        photoUrl = await getDownloadURL(storageRef);
      }

      // 3. Save to Firestore
      btn.textContent = "Saving to Cloud...";
      const birthDate = document.getElementById('mBirthday').value;

      await addDoc(collection(db, "members"), {
        last_name: document.getElementById('mSurname').value,
        first_name: document.getElementById('mFirstname').value,
        other_names: document.getElementById('mOthername').value,
        gender: document.getElementById('mGender').value,
        dob: birthDate,
        dob_day_month: birthDate ? birthDate.substring(5) : null,
        phone: phone,
        hostel: document.getElementById('mHostel').value, // FIXED: Hostel now included
        level: document.getElementById('mLevel').value,
        course: document.getElementById('mCourse').value,
        status: document.getElementById('mStatus').value,
        emergency_name: document.getElementById('mEmergencyName').value,
        emergency_phone: document.getElementById('mEmergencyPhone').value,
        photo_url: photoUrl, // NEW: Photo URL included
        recorded_by_id: auth.currentUser.uid,
        pastorId: pId,
        shepherdId: sId,
        timestamp: new Date().toISOString()
      });

      alert("Member added successfully!");
      window.location.reload();
    } catch (e) {
      alert("Error: " + e.message);
      btn.disabled = false;
      btn.innerText = "Try Again";
    }
  });
</script>
</body>
</html>
