<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add New Staff | ShepherdNet</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/60bRQP5Z/Jewels-background-removed.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <style>
    :root { 
        --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.05); 
        --border: rgba(255, 255, 255, 0.1); --text-dim: #888;
        --success: #00ff88; --error: #ff4b5c;
    }
    
    body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; padding: 40px 20px; margin: 0; overflow-x: hidden; }
    .signup-container { width: 100%; max-width: 650px; background: var(--glass); padding: 40px; border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
    h2 { color: var(--primary); margin-bottom: 30px; text-align: center; font-weight: 600; letter-spacing: 1px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: span 2; }
    .hidden { display: none; }

    .form-group { margin-bottom: 5px; }
    label { display: block; font-size: 0.7rem; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    
    input, select { 
        width: 100%; padding: 12px; background: rgba(0,0,0,0.3); 
        border: 1px solid var(--border); border-radius: 10px; 
        color: white; font-family: inherit; box-sizing: border-box; 
        transition: 0.3s;
    }
    input:focus, select:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.4); }

    .btn-register { 
        width: 100%; padding: 16px; background: var(--primary); 
        border: none; border-radius: 12px; color: #0f172a; 
        font-weight: 600; cursor: pointer; margin-top: 30px; transition: 0.3s;
    }
    .btn-register:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3); }
    .back-link { color: var(--text-dim); text-decoration: none; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; margin-bottom: 20px; }

    /* --- TOAST NOTIFICATION CSS --- */
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        min-width: 300px;
        background: #1e293b;
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        border-left: 5px solid var(--success);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        animation: slideIn 0.5s ease forwards, fadeOut 0.5s ease 4.5s forwards;
    }

    .toast.error { border-left-color: var(--error); }

    .toast-content { display: flex; align-items: center; gap: 12px; font-size: 0.9rem; }

    .close-toast {
        background: none;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        padding: 0 0 0 10px;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
    }
  </style>
</head>
<body>

<div id="toast-container"></div>

<div class="signup-container">
  <a href="https://jewelsinthepalace2-create.github.io/ShepherdNetfob/admin/index.html" class="back-link">← Return to Admin Panel</a>
  <h2 id="pageTitle">Register New Staff</h2>

  <form id="signupForm">
    <div class="form-grid">
      <div class="form-group">
        <label>System Role</label>
        <select id="role" required>
          <option value="shepherds">Shepherd</option>
          <option value="pastors">Pastor</option>
          <option value="members">Church Member</option>
        </select>
      </div>
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="fullName" placeholder="e.g. Kofi Mensah" required>
      </div>

      <div class="form-group full-width hidden" id="chapelFieldGroup">
        <label>Name of Chapel</label>
        <input type="text" id="chapelName" placeholder="Enter branch name">
      </div>

      <div class="form-group">
        <label>Gender</label>
        <select id="gender" required>
            <option value="" disabled selected>Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
      </div>
      <div class="form-group">
        <label>Birthday</label>
        <input type="date" id="dob" required>
      </div>

      <div class="form-group">
        <label>Contact Number</label>
        <input type="tel" id="contact" placeholder="024XXXXXXX" required>
      </div>
      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="email" required>
      </div>

      <div class="form-group full-width">
        <label>Current Job / Occupation</label>
        <input type="text" id="job" placeholder="e.g. Teacher, Software Developer">
      </div>

      <div class="form-group">
        <label>Course of Study</label>
        <input type="text" id="course" placeholder="e.g. BSc Admin">
      </div>
      <div class="form-group">
        <label>Level (e.g. 400, Alumnus)</label>
        <input type="text" id="level" placeholder="Level">
      </div>

      <div class="form-group full-width">
        <label>Initial Password</label>
        <input type="password" id="password" required minlength="6">
      </div>
    </div>

    <button type="submit" class="btn-register" id="submitBtn">Create User Account</button>
  </form>
</div>

<script type="module">
  import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- INITIALIZE EMAILJS ---
  (function() {
      emailjs.init("hbLNGNgE4WvbIYFFr");
  })();

  const firebaseConfig = { 
    apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", 
    authDomain: "fob-database-139d1.firebaseapp.com", 
    projectId: "fob-database-139d1", 
    storageBucket: "fob-database-139d1.firebasestorage.app", 
    messagingSenderId: "375165731354", 
    appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" 
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app, "fobrealdbase");

  let creatorRole = "master"; 
  let currentCreatorUID = "";

  // --- TOAST HELPER FUNCTION ---
  function showToast(message, type = "success") {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type === "error" ? "error" : ""}`;
      
      toast.innerHTML = `
          <div class="toast-content">
              <span>${type === "success" ? "✅" : "❌"}</span>
              <span>${message}</span>
          </div>
          <button class="close-toast">&times;</button>
      `;

      container.appendChild(toast);

      // Close on button click
      toast.querySelector('.close-toast').addEventListener('click', () => {
          toast.style.animation = "fadeOut 0.5s ease forwards";
          setTimeout(() => toast.remove(), 500);
      });

      // Auto remove after 5 seconds
      setTimeout(() => {
          if (toast.parentElement) toast.remove();
      }, 5000);
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentCreatorUID = user.uid;
        const shepherdCheck = await getDoc(doc(db, "shepherds", user.uid));
        if (shepherdCheck.exists()) {
            creatorRole = "shepherd";
            document.getElementById('role').innerHTML = '<option value="members">Church Member</option>';
            document.getElementById('pageTitle').innerText = "Register New Member";
        } else {
            creatorRole = "pastor";
        }
    } else {
        window.location.href = "../login.html";
    }
  });

  const roleSelect = document.getElementById('role');
  const chapelGroup = document.getElementById('chapelFieldGroup');
  roleSelect.addEventListener('change', () => {
    roleSelect.value === 'pastors' ? chapelGroup.classList.remove('hidden') : chapelGroup.classList.add('hidden');
  });

  document.getElementById('signupForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "Processing...";

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const fullName = document.getElementById('fullName').value;
    const collectionName = document.getElementById('role').value; 
    const roleString = collectionName.slice(0, -1); 
    const chapelName = document.getElementById('chapelName').value || "N/A";

    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    try {
      const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
      
      const userData = {
        full_name: fullName,
        gender: document.getElementById('gender').value,
        dob: document.getElementById('dob').value,
        contact: document.getElementById('contact').value,
        email: email,
        job: document.getElementById('job').value,
        course: document.getElementById('course').value,
        level: document.getElementById('level').value,
        role: roleString,
        created_at: serverTimestamp(),
        pastorId: (creatorRole === 'pastor' || creatorRole === 'master') ? currentCreatorUID : "N/A",
        shepherdId: (creatorRole === 'shepherd') ? currentCreatorUID : "N/A"
      };

      if (roleString === 'pastor') userData.chapel_name = chapelName;

      await setDoc(doc(db, collectionName, userCredential.user.uid), userData);

      await emailjs.send("service_vzxws9f", "template_buctifq", {
          full_name: fullName,
          role: roleString,
          email: email,
          password: password,
          chapel_name: roleString === 'pastor' ? chapelName : "General"
      });

      await signOut(secondaryAuth);
      await deleteApp(secondaryApp);

      showToast(`Success! ${fullName} registered and linked.`);
      document.getElementById('signupForm').reset();
      chapelGroup.classList.add('hidden');

    } catch (error) {
      showToast(error.message, "error");
    } finally {
      btn.disabled = false;
      btn.innerText = "Create User Account";
    }
  };
</script>
</body>
</html>
