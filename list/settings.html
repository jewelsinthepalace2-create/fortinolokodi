<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Profile Settings | ShepherdNet</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/60bRQP5Z/Jewels-background-removed.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { 
        /* Dark Mode (Default) */
        --primary: #4facfe; 
        --bg: #0f172a;
        --glass: rgba(255, 255, 255, 0.05); 
        --border: rgba(255, 255, 255, 0.1); 
        --text: #ffffff;
        --text-dim: rgba(255, 255, 255, 0.5);
        --input-bg: rgba(0,0,0,0.2);
    }

    [data-theme="light"] {
        /* Light Mode */
        --bg: #f1f5f9;
        --glass: #ffffff;
        --border: #e2e8f0;
        --text: #0f172a;
        --text-dim: #64748b;
        --input-bg: #f8fafc;
    }

    body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; transition: 0.3s; }
    
    .settings-container { width: 100%; max-width: 500px; background: var(--glass); padding: 40px 30px; border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); height: fit-content; margin-top: 20px; }
    
    .header { text-align: center; margin-bottom: 30px; }
    .role-badge { display: inline-block; padding: 6px 18px; background: var(--primary); color: #0f172a; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; }
    
    /* Profile Image */
    .profile-pic-container { position: relative; width: 110px; height: 110px; margin: 0 auto 20px auto; }
    #profileDisplay { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); background: #1e293b; transition: 0.3s; }
    .upload-label { position: absolute; bottom: 0; right: 0; background: var(--primary); color: #0f172a; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.4rem; border: 3px solid var(--bg); font-weight: bold; }
    #fileInput { display: none; }

    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    input { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: inherit; box-sizing: border-box; outline: none; transition: 0.3s; }
    input:focus { border-color: var(--primary); }
    input:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-save { width: 100%; padding: 16px; background: var(--primary); border: none; border-radius: 12px; color: #0f172a; font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px; font-size: 1rem; }
    .btn-save:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3); }

    .theme-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .theme-btn { background: var(--glass); border: 1px solid var(--border); color: var(--text); padding: 8px 15px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; }

    .security-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    .secondary-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); width: 100%; padding: 12px; border-radius: 12px; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
    .secondary-btn:hover { color: var(--text); border-color: var(--text); }
    
    .back-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-family: inherit; font-size: 0.9rem; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center; transition: 0.3s; }
    .back-btn:hover { color: var(--primary); }
  </style>
</head>
<body>

<div class="settings-container">
  <button id="backBtn" class="back-btn">‚Üê Return to Dashboard</button>
  
  <div class="header">
    <div class="profile-pic-container">
        <img id="profileDisplay" src="https://via.placeholder.com/110?text=User" alt="Profile">
        <label for="fileInput" class="upload-label">+</label>
        <input type="file" id="fileInput" accept="image/*">
    </div>
    <div id="userRole" class="role-badge">Loading...</div>
    <h2 id="displayTitle">Profile Settings</h2>
  </div>

  <div class="form-group">
    <label>Full Name</label>
    <input type="text" id="fullName" placeholder="Enter your full name">
  </div>

  <div class="form-group">
    <label>Email Address</label>
    <input type="email" id="userEmail" disabled>
  </div>

  <button id="saveProfile" class="btn-save">Update Profile</button>

  <div class="theme-section">
      <label style="margin: 0;">App Appearance</label>
      <button id="themeToggle" class="theme-btn">
          <span id="themeIcon">üåô</span> <span id="themeText">Dark Mode</span>
      </button>
  </div>

  <div class="security-section">
    <label>Account Security</label>
    <button id="resetPass" class="secondary-btn">Send Password Reset Email</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { initializeFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", 
    authDomain: "fob-database-139d1.firebaseapp.com", 
    projectId: "fob-database-139d1", 
    storageBucket: "fob-database-139d1.firebasestorage.app", 
    messagingSenderId: "375165731354", 
    appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" 
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = initializeFirestore(app, { experimentalForceLongPolling: true }, "fobrealdbase");
  const storage = getStorage(app);

  let currentRoleColl = "";
  let selectedFile = null;

  // --- THEME ENGINE ---
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const themeText = document.getElementById('themeText');
  
  function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      themeIcon.innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      themeText.innerText = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
      localStorage.setItem('theme', theme);
  }

  const savedTheme = localStorage.getItem('theme') || 'dark';
  applyTheme(savedTheme);

  themeToggle.onclick = () => {
      const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
  };

  // --- AUTH & DATA LOADING ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById('userEmail').value = user.email;
      await loadUserData(user.uid);
    } else { window.location.href = "../index.html"; }
  });

  async function loadUserData(uid) {
    const roles = [
      { coll: "pastors", label: "Pastor" },
      { coll: "shepherds", label: "Shepherd" }
    ];

    // Check Pastors collection first
    for (let r of roles) {
      const snap = await getDoc(doc(db, r.coll, uid));
      if (snap.exists()) {
        currentRoleColl = r.coll;
        const d = snap.data();
        document.getElementById('userRole').innerText = r.label;
        document.getElementById('fullName').value = d.full_name || "";
        if (d.profile_pic) document.getElementById('profileDisplay').src = d.profile_pic;
        return;
      }
    }
    // Fallback if not in those (Check for admin if applicable)
    document.getElementById('userRole').innerText = "Admin";
    currentRoleColl = "pastors"; 
  }

  document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            alert("Image must be under 2MB");
            return;
        }
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (event) => document.getElementById('profileDisplay').src = event.target.result;
        reader.readAsDataURL(file);
    }
  };

  // Smart Back Button with Role-Specific Routing
  document.getElementById('backBtn').onclick = async () => {
    const btn = document.getElementById('backBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = "Verifying Role..."; // Feedback during async check
    
    try {
        const uid = auth.currentUser.uid;

        // 1. Check Master Admin
        const adminSnap = await getDoc(doc(db, "master_admin", uid));
        if (adminSnap.exists()) {
            window.location.href = "../admin/index.html";
            return;
        }

        // 2. Check Pastor
        const pastorSnap = await getDoc(doc(db, "pastors", uid));
        if (pastorSnap.exists()) {
            window.location.href = "../pastor/index.html";
            return;
        }

        // 3. Default to Shepherd (or check shepherd collection)
        // We can check the shepherd collection explicitly for safety
        const shepherdSnap = await getDoc(doc(db, "shepherds", uid));
        if (shepherdSnap.exists()) {
            window.location.href = "../shepherd/index.html";
            return;
        }

        // Fallback if no specific role record is found
        window.location.href = "../index.html"; 
        
    } catch (error) {
        console.error("Routing error:", error);
        btn.innerHTML = originalText;
        alert("Navigation failed. Please try again.");
    }
  };

  document.getElementById('saveProfile').onclick = async () => {
    const btn = document.getElementById('saveProfile');
    btn.disabled = true; btn.innerText = "Saving Changes...";
    const uid = auth.currentUser.uid;
    let updateData = { full_name: document.getElementById('fullName').value };

    try {
      if (selectedFile) {
        const fileRef = ref(storage, `profiles/${uid}`);
        await uploadBytes(fileRef, selectedFile);
        updateData.profile_pic = await getDownloadURL(fileRef);
      }
      await updateDoc(doc(db, currentRoleColl, uid), updateData);
      alert("Success! Your profile has been updated.");
    } catch (e) { alert("Error: " + e.message); }
    finally { btn.disabled = false; btn.innerText = "Update Profile"; }
  };

  document.getElementById('resetPass').onclick = async () => {
    if (confirm("Send password reset link to " + auth.currentUser.email + "?")) {
      try {
          await sendPasswordResetEmail(auth, auth.currentUser.email);
          alert("Reset email sent! Please check your inbox.");
      } catch (e) { alert(e.message); }
    }
  };
</script>
</body>
</html>
