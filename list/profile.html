<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Member Profile | ShepherdNet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.07); --border: rgba(255, 255, 255, 0.15); }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; min-height: 100vh; padding: 20px; }

    .container { max-width: 500px; margin: 0 auto; padding-bottom: 100px; }
    
    /* Profile Header */
    .profile-header { text-align: center; padding: 30px 20px; background: var(--glass); border-radius: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
    .avatar-circle { width: 80px; height: 80px; background: linear-gradient(45deg, #4facfe, #00f2fe); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; color: #0f172a; }
    h1 { font-size: 1.5rem; margin-bottom: 5px; }
    .badge { background: rgba(79, 172, 254, 0.2); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }

    /* Info Sections */
    .info-card { background: var(--glass); border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; }
    .section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); margin-bottom: 15px; display: block; opacity: 0.8; }
    
    .data-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .data-row:last-child { border: none; }
    .label { color: #888; font-size: 0.85rem; }
    .value { font-weight: 400; font-size: 0.95rem; text-align: right; }

    /* Inputs (Hidden by default) */
    .edit-mode { display: none; width: 100%; background: #1e293b; border: 1px solid var(--primary); color: white; padding: 10px; border-radius: 8px; font-family: inherit; margin-top: 5px; }

    /* Action Buttons */
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; text-align: center; text-decoration: none; }
    .btn-edit { background: var(--glass); color: white; border: 1px solid var(--border); }
    .btn-call { background: var(--primary); color: #0f172a; }
    .btn-save { display: none; background: #10b981; color: white; width: 100%; margin-top: 10px; }
    .btn-delete { color: #ff6b6b; font-size: 0.8rem; background: none; border: none; width: 100%; margin-top: 30px; opacity: 0.6; }

    .back-nav { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: #888; text-decoration: none; font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="container">
  <a href="index.html" class="back-nav">← Back to Flock</a>

  <div class="profile-header">
    <div class="avatar-circle" id="avatar-initial">-</div>
    <h1 id="pName_view">Loading...</h1>
    <input type="text" id="pFirstName_edit" class="edit-mode" placeholder="First Name">
    <input type="text" id="pLastName_edit" class="edit-mode" placeholder="Last Name">
    <span class="badge" id="pStatus_view">...</span>
    <select id="pStatus_edit" class="edit-mode">
        <option value="New Convert">New Convert</option>
        <option value="Established Member">Established Member</option>
    </select>
  </div>

  <div class="info-card">
    <span class="section-title">Contact Information</span>
    <div class="data-row">
      <span class="label">Phone</span>
      <span class="value" id="pPhone_view">-</span>
      <input type="tel" id="pPhone_edit" class="edit-mode">
    </div>
    <div class="data-row">
      <span class="label">Address / Hostel</span>
      <span class="value" id="pHostel_view">-</span>
      <input type="text" id="pHostel_edit" class="edit-mode">
    </div>
  </div>

  <div class="info-card">
    <span class="section-title">Personal Info</span>
    <div class="data-row">
      <span class="label">Gender</span>
      <span class="value" id="pGender_view">-</span>
      <select id="pGender_edit" class="edit-mode"><option value="Male">Male</option><option value="Female">Female</option></select>
    </div>
    <div class="data-row">
      <span class="label">Birthday</span>
      <span class="value" id="pBirthday_view">-</span>
      <input type="date" id="pBirthday_edit" class="edit-mode">
    </div>
  </div>

  <div class="info-card">
    <span class="section-title">Academic & Emergency</span>
    <div class="data-row">
      <span class="label">Course</span>
      <span class="value" id="pCourse_view">-</span>
      <input type="text" id="pCourse_edit" class="edit-mode">
    </div>
    <div class="data-row">
      <span class="label">Level</span>
      <span class="value" id="pLevel_view">-</span>
      <input type="text" id="pLevel_edit" class="edit-mode">
    </div>
  </div>

  <div class="btn-group" id="normal-btns">
    <button id="toggleEdit" class="btn btn-edit">Edit Profile</button>
    <a href="#" id="callLink" class="btn btn-call">Call Member</a>
  </div>

  <button id="saveBtn" class="btn btn-save">Save Changes</button>
  <button id="deleteBtn" class="btn btn-delete">Delete Permanentely</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
// Add getFirestore here
import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = { 
  apiKey: "AIzaSyCBv60eRCO0e4dFBMKGKnIATouxTuk1Bcc", 
  authDomain: "fob-database-139d1.firebaseapp.com", 
  projectId: "fob-database-139d1", 
  storageBucket: "fob-database-139d1.firebasestorage.app", 
  messagingSenderId: "375165731354", 
  appId: "1:375165731354:web:b5fa57dcb2d71ee0d8c7a3" 
};

const app = initializeApp(firebaseConfig);

// Use getFirestore and pass the database name as the second argument
const db = getFirestore(app, "fobrealdbase");

  const urlParams = new URLSearchParams(window.location.search);
  const rawId = urlParams.get('id');
  const docId = rawId ? rawId.split('#')[0] : null; // This removes everything after the #
  async function loadProfile() {
    if (!docId) return;
    try {
        const docSnap = await getDoc(doc(db, "members", docId));
        if (docSnap.exists()) {
          const d = docSnap.data();
          
          // Mapping fields to database names (first_name, last_name, dob, etc)
          const fullName = `${d.first_name || ''} ${d.last_name || ''}`.trim();
          document.getElementById('pName_view').textContent = fullName || "No Name";
          document.getElementById('avatar-initial').textContent = d.first_name ? d.first_name[0] : "?";
          
          document.getElementById('pStatus_view').textContent = d.status || "-";
          document.getElementById('pGender_view').textContent = d.gender || "-";
          document.getElementById('pBirthday_view').textContent = d.dob || "-"; // database is dob
          document.getElementById('pPhone_view').textContent = d.phone || "-";
          document.getElementById('pHostel_view').textContent = d.hostel || "-"; // database is hostel
          document.getElementById('pCourse_view').textContent = d.course || "-";
          document.getElementById('pLevel_view').textContent = d.level || "-";
          
          // Set Edit Inputs
          document.getElementById('pFirstName_edit').value = d.first_name || "";
          document.getElementById('pLastName_edit').value = d.last_name || "";
          document.getElementById('pStatus_edit').value = d.status || "New Convert";
          document.getElementById('pGender_edit').value = d.gender || "Male";
          document.getElementById('pBirthday_edit').value = d.dob || "";
          document.getElementById('pPhone_edit').value = d.phone || "";
          document.getElementById('pHostel_edit').value = d.hostel || "";
          document.getElementById('pCourse_edit').value = d.course || "";
          document.getElementById('pLevel_edit').value = d.level || "";

          if(d.phone) document.getElementById('callLink').href = `tel:${d.phone}`;
        }
    } catch (err) { console.error(err); }
  }

  document.getElementById('toggleEdit').addEventListener('click', () => {
    const isEditing = document.getElementById('saveBtn').style.display === "block";
    document.querySelectorAll('.value').forEach(el => el.style.display = isEditing ? "block" : "none");
    document.querySelectorAll('.edit-mode').forEach(el => el.style.display = isEditing ? "none" : "block");
    document.getElementById('saveBtn').style.display = isEditing ? "none" : "block";
    document.getElementById('callLink').style.display = isEditing ? "flex" : "none";
    document.getElementById('toggleEdit').textContent = isEditing ? "Edit Profile" : "Cancel";
  });

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.textContent = "Updating...";
    try {
      const birthDate = document.getElementById('pBirthday_edit').value;
      await updateDoc(doc(db, "members", docId), {
        first_name: document.getElementById('pFirstName_edit').value,
        last_name: document.getElementById('pLastName_edit').value,
        status: document.getElementById('pStatus_edit').value,
        gender: document.getElementById('pGender_edit').value,
        dob: birthDate,
        dob_day_month: birthDate ? birthDate.substring(5) : null,
        phone: document.getElementById('pPhone_edit').value,
        hostel: document.getElementById('pHostel_edit').value,
        course: document.getElementById('pCourse_edit').value,
        level: document.getElementById('pLevel_edit').value
      });
      location.reload();
    } catch (e) { alert("Error: " + e.message); btn.disabled = false; }
  });

  document.getElementById('deleteBtn').addEventListener('click', async () => {
    if (confirm("⚠️ Permanent Delete?\n\nThis member will be removed forever.")) {
        if (confirm("FINAL WARNING: Are you sure?")) {
            await deleteDoc(doc(db, "members", docId));
            window.location.href = "index.html";
        }
    }
  });

  loadProfile();
</script>
</body>
</html>
